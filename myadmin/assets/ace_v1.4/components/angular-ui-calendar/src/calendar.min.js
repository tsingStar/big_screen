angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$locale",function(a,t){var u=a.eventSources,e=a.calendarWatchEvent?a.calendarWatchEvent:angular.noop,r=1;this.eventFingerprint=function(n){return n._id||(n._id=r++),""+n._id+(n.id||"")+(n.title||"")+(n.url||"")+(+n.start||"")+(+n.end||"")+(n.allDay||"")+(n.className||"")+e({event:n})||""};var l=1,o=1;this.sourceFingerprint=function(n){var e=""+(n.__id||(n.__id=l++)),r=angular.isObject(n)&&n.events;return r&&(e=e+"-"+(r.__id||(r.__id=o++))),e},this.allEvents=function(){for(var n=[],e=0,r=u.length;e<r;e++){var a=u[e];if(angular.isArray(a))n.push(a);else if(angular.isObject(a)&&angular.isArray(a.events)){var t={};for(var l in a)"_id"!==l&&"events"!==l&&(t[l]=a[l]);for(var o=0;o<a.events.length;o++)angular.extend(a.events[o],t);n.push(a.events)}}return Array.prototype.concat.apply([],n)},this.changeWatcher=function(o,f){function e(){for(var n,e,r=angular.isFunction(o)?o():o,a=[],t=0,l=r.length;t<l;t++)e=r[t],n=f(e),g[n]=e,a.push(n);return a}function s(n,e){var r,a,t=[],l={};for(r=0,a=e.length;r<a;r++)l[e[r]]=!0;for(r=0,a=n.length;r<a;r++)l[n[r]]||t.push(n[r]);return t}var v,g={};return v={subscribe:function(n,r){n.$watch(e,function(n,e){r&&!1===r(n,e)||function(n,e){var r,a,t,l,o={},u=s(e,n);for(r=0,a=u.length;r<a;r++){var i=u[r];t=g[i],delete g[i];var c=f(t);c===i?v.onRemoved(t):(o[c]=i,v.onChanged(t))}var d=s(n,e);for(r=0,a=d.length;r<a;r++)l=d[r],t=g[l],o[l]||v.onAdded(t)}(n,e)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(n,e){var r={};return angular.extend(r,e),angular.extend(r,n),angular.forEach(r,function(n,e){"function"==typeof n&&(r[e]=function(r){return function(){if(a.$root.$$phase)return r.apply(this,arguments);var n=arguments,e=this;return a.$root.$apply(function(){return r.apply(e,n)})}}(r[e]))}),r},this.getLocaleConfig=function(n){if(n.lang&&!n.useNgLocale)return{};function e(n){var e,r;for(r in e=[],n)e[r]=n[r];return e}var r=t.DATETIME_FORMATS;return{monthNames:e(r.MONTH),monthNamesShort:e(r.SHORTMONTH),dayNames:e(r.DAY),dayNamesShort:e(r.SHORTDAY)}}}]).directive("uiCalendar",["uiCalendarConfig",function(d){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(l,n,o,u){var t,i=l.eventSources,e=!1,r=u.changeWatcher(i,u.sourceFingerprint),a=u.changeWatcher(u.allEvents,u.eventFingerprint),c=null;l.destroy=function(){t&&t.fullCalendar&&t.fullCalendar("destroy"),t=o.calendar?d.calendars[o.calendar]=$(n).html(""):$(n).html("")},l.init=function(){t.fullCalendar(c),o.calendar&&(d.calendars[o.calendar]=t)},r.onAdded=function(n){t.fullCalendar("addEventSource",n),e=!0},r.onRemoved=function(n){t.fullCalendar("removeEventSource",n),e=!0},r.onChanged=function(n){t.fullCalendar("refetchEvents"),e=!0},a.onAdded=function(n){t.fullCalendar("renderEvent",n,!!n.stick)},a.onRemoved=function(n){t.fullCalendar("removeEvents",n._id)},a.onChanged=function(n){for(var e=t.fullCalendar("clientEvents",n._id),r=0;r<e.length;r++){var a=e[r];a=angular.extend(a,n),t.fullCalendar("updateEvent",a)}},r.subscribe(l),a.subscribe(l,function(){return!0===e?e=!1:void 0}),l.$watch(function(){var n,e=o.uiCalendar?l.$parent.$eval(o.uiCalendar):{};n=u.getFullCalendarConfig(e,d);var r=u.getLocaleConfig(n);angular.extend(r,n),c={eventSources:i},angular.extend(c,r),c.calendars=null;var a={};for(var t in c)"eventSources"!==t&&(a[t]=c[t]);return JSON.stringify(a)},function(n,e){l.destroy(),l.init()})}}}]);
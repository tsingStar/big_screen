angular.module("colorpicker.module",[]).factory("Helper",function(){"use strict";return{closestSlider:function(e){return(e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector).bind(e)("I")?e.parentNode:e},getOffset:function(e,o){for(var t=0,n=0,r=e.getBoundingClientRect();e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)o||"BODY"!==e.tagName?(t+=e.scrollLeft,n+=e.scrollTop):(t+=document.documentElement.scrollLeft||e.scrollLeft,n+=document.documentElement.scrollTop||e.scrollTop),e=e.offsetParent;return{top:r.top+window.pageYOffset,left:r.left+window.pageXOffset,scrollX:t,scrollY:n}},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[2.55*e[1],2.55*e[2],2.55*e[3],e[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}]}}).factory("Color",["Helper",function(i){"use strict";return{value:{h:1,s:1,b:1,a:1},rgb:function(){var e=this.toRGB();return"rgb("+e.r+","+e.g+","+e.b+")"},rgba:function(){var e=this.toRGB();return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(e,o,t,n){var r,i;return e/=255,o/=255,t/=255,{h:((0==(i=(r=Math.max(e,o,t))-Math.min(e,o,t))?null:r===e?(o-t)/i:r===o?(t-e)/i+2:(e-o)/i+4)+360)%6*60/360||1,s:0==i?0:i/r,b:r,a:n||1}},setColor:function(e){for(var o in e=e?e.toLowerCase():e,i.stringParsers)if(i.stringParsers.hasOwnProperty(o)){var t=i.stringParsers[o],n=t.re.exec(e),r=n&&t.parse(n);if(r)return this.value=this.RGBtoHSB.apply(null,r),!1}},setHue:function(e){this.value.h=1-e},setSaturation:function(e){this.value.s=e},setLightness:function(e){this.value.b=1-e},setAlpha:function(e){this.value.a=parseInt(100*(1-e),10)/100},toRGB:function(e,o,t,n){var r,i,l,c,s;return e||(e=this.value.h,o=this.value.s,t=this.value.b),e=(e*=360)%360/60,r=i=l=t-(s=t*o),r+=[s,c=s*(1-Math.abs(e%2-1)),0,0,c,s][e=~~e],i+=[c,s,s,c,0,0][e],l+=[0,0,c,s,s,c][e],{r:Math.round(255*r),g:Math.round(255*i),b:Math.round(255*l),a:n||this.value.a}},toHex:function(e,o,t,n){var r=this.toRGB(e,o,t,n);return"#"+(1<<24|parseInt(r.r,10)<<16|parseInt(r.g,10)<<8|parseInt(r.b,10)).toString(16).substr(1)}}}]).factory("Slider",["Helper",function(c){"use strict";var s={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},a={};return{getSlider:function(){return s},getLeftPosition:function(e){return Math.max(0,Math.min(s.maxLeft,s.left+((e.pageX||a.left)-a.left)))},getTopPosition:function(e){return Math.max(0,Math.min(s.maxTop,s.top+((e.pageY||a.top)-a.top)))},setSlider:function(e,o){var t=c.closestSlider(e.target),n=c.getOffset(t,o),r=t.getBoundingClientRect(),i=e.clientX-r.left,l=e.clientY-r.top;s.knob=t.children[0].style,s.left=e.pageX-n.left-window.pageXOffset+n.scrollX,s.top=e.pageY-n.top-window.pageYOffset+n.scrollY,a={left:e.pageX-(i-s.left),top:e.pageY-(l-s.top)}},setSaturation:function(e,o){s={maxLeft:100,maxTop:100,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e,o)},setHue:function(e,o){s={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setHue"},this.setSlider(e,o)},setAlpha:function(e,o){s={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setAlpha"},this.setSlider(e,o)},setKnob:function(e,o){s.knob.top=e+"px",s.knob.left=o+"px"}}}]).directive("colorpicker",["$document","$compile","Color","Slider","Helper",function(H,T,O,y,M){"use strict";return{require:"?ngModel",restrict:"A",link:function(i,l,t,c){function o(){H.on("mousemove",n),H.on("mouseup",e)}function s(){try{L.css("backgroundColor",S[h]())}catch(e){L.css("backgroundColor",S.toHex())}C.css("backgroundColor",S.toHex(S.value.h,1,1,1)),"rgba"===h&&(d.css.backgroundColor=S.toHex())}function n(e){var o=y.getLeftPosition(e),t=y.getTopPosition(e),n=y.getSlider();y.setKnob(t,o),n.callLeft&&S[n.callLeft].call(S,o/100),n.callTop&&S[n.callTop].call(S,t/100),s();var r=S[h]();return l.val(r),c&&i.$apply(c.$setViewValue(r)),b&&P.val(r),!1}function e(){p("colorpicker-selected"),H.off("mousemove",n),H.off("mouseup",e)}function r(e){S.setColor(l.val()),b&&!e&&P.val(l.val()),$.eq(0).css({left:100*S.value.s+"px",top:100-100*S.value.b+"px"}),$.eq(1).css("top",100*(1-S.value.h)+"px"),$.eq(2).css("top",100*(1-S.value.a)+"px"),s()}function a(){f()}function u(){w.hasClass("colorpicker-visible")||(r(),w.addClass("colorpicker-visible").css(function(){var e,o=M.getOffset(l[0]);return angular.isDefined(t.colorpickerParent)&&(o.left=0,o.top=0),"top"===g?e={top:o.top-147,left:o.left}:"right"===g?e={top:o.top,left:o.left+126}:"bottom"===g?e={top:o.top+l[0].offsetHeight+2,left:o.left}:"left"===g&&(e={top:o.top,left:o.left-150}),{top:e.top+"px",left:e.left+"px"}}()),p("colorpicker-shown"),!1===k&&H.on("mousedown",a),t.colorpickerIsOpen&&(i[t.colorpickerIsOpen]=!0,i.$$phase||i.$digest()))}function p(e){c&&i.$emit(e,{name:t.ngModel,value:c.$modelValue})}function f(){w.hasClass("colorpicker-visible")&&(w.removeClass("colorpicker-visible"),p("colorpicker-closed"),H.off("mousedown",a),t.colorpickerIsOpen&&(i[t.colorpickerIsOpen]=!1,i.$$phase||i.$digest()))}var d,h=t.colorpicker?t.colorpicker:"hex",g=angular.isDefined(t.colorpickerPosition)?t.colorpickerPosition:"bottom",k=!!angular.isDefined(t.colorpickerInline)&&t.colorpickerInline,m=!!angular.isDefined(t.colorpickerFixedPosition)&&t.colorpickerFixedPosition,v=angular.isDefined(t.colorpickerParent)?l.parent():angular.element(document.body),b=!!angular.isDefined(t.colorpickerWithInput)&&t.colorpickerWithInput,x='<div class="colorpicker dropdown"><div class="dropdown-menu"><colorpicker-saturation><i></i></colorpicker-saturation><colorpicker-hue><i></i></colorpicker-hue><colorpicker-alpha><i></i></colorpicker-alpha><colorpicker-preview></colorpicker-preview>'+(b?'<input type="text" name="colorpicker-input" spellcheck="false">':"")+(k?"":'<button type="button" class="close close-colorpicker">&times;</button>')+"</div></div>",w=angular.element(x),S=O,I=w.find("colorpicker-hue"),C=w.find("colorpicker-saturation"),L=w.find("colorpicker-preview"),$=w.find("i");if(T(w)(i),b){var P=w.find("input");P.on("mousedown",function(e){e.stopPropagation()}).on("keyup",function(){var e=this.value;l.val(e),c&&c.$modelValue!==e&&(i.$apply(c.$setViewValue(e)),r(!0))})}"rgba"===h&&(w.addClass("alpha"),(d=w.find("colorpicker-alpha")).on("click",function(e){y.setAlpha(e,m),n(e)}).on("mousedown",function(e){y.setAlpha(e,m),o()}).on("mouseup",function(e){p("colorpicker-selected-alpha")})),I.on("click",function(e){y.setHue(e,m),n(e)}).on("mousedown",function(e){y.setHue(e,m),o()}).on("mouseup",function(e){p("colorpicker-selected-hue")}),C.on("click",function(e){y.setSaturation(e,m),n(e),angular.isDefined(t.colorpickerCloseOnSelect)&&f()}).on("mousedown",function(e){y.setSaturation(e,m),o()}).on("mouseup",function(e){p("colorpicker-selected-saturation")}),m&&w.addClass("colorpicker-fixed-position"),w.addClass("colorpicker-position-"+g),"true"===k&&w.addClass("colorpicker-inline"),v.append(w),c&&(c.$render=function(){l.val(c.$viewValue),r()}),l.on("blur keyup change",function(){r()}),l.on("$destroy",function(){w.remove()}),!1===k?l.on("click",u):u(),w.on("mousedown",function(e){e.stopPropagation(),e.preventDefault()}),w.find("button").on("click",function(){f()}),t.colorpickerIsOpen&&i.$watch(t.colorpickerIsOpen,function(e){!0===e?u():!1===e&&f()})}}}]);
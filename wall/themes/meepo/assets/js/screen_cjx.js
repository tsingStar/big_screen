var $ResultSeed,Players,Winers,audio_Running,audio_GetOne,resizePart=window.WBActivity.resize=function(){},start=window.WBActivity.start=function(){window.WBActivity.hideLoading();var t=document.getElementById("Audio_Running");t.play&&(audio_Running=t);var e=document.getElementById("Audio_Result");e.play&&(audio_GetOne=e),$(".usercount-label").html("加载数据中..."),$(".control").hide(),getReady(),$(".Panel.Top").css({top:0}),$(".Panel.Bottom").css({bottom:0}),$(".Panel.Lottery").css({display:"block",opacity:1}),$ResultSeed=$(".lottery-right .result-line"),$(".control.button-run").on("click",function(){start_game()}),$(".control.button-stop").on("click",function(){stop_game()}),$(".control.button-nextround").on("click",function(){window.location.reload()}),$(".button-reload").on("click",function(){window.location.reload()}),$(".select-button").on("click",function(t){var e=$(this),n=$(".select-value"),a=n.text();return e.hasClass("minus")?1<a&&(a--,n.text(a)):e.hasClass("plus")&&(a<Players.length?a++:n=Players.length,n.text(a)),t.preventDefault(),!1})};function changeLuck(t){-1!=t&&getReady()}var tmr_playanimate,getReady=function(){var t=$("#tagid").val();if(-1==t)return!1;$(".lottery-right .result-line").remove(),$.getJSON(PATH_ACTIVITY+Path_url("ajax_act_lottory.php?action=ready"),{from:"cjx",awardid:t},function(t){if(console.log(t),0==t.ret&&0<t.data.length){(Players=t.data).length;$(".usercount-label").html(t.count+"人"),$("#leftperson").val(t.count),$(".control.button-run").fadeIn(),null!=t.luckuser&&$.each(t.luckuser,function(t,e){var n='<div class="result-line had_luck_user" style="display: block;">';n+='<div class="result-num">'+(t+1)+"</div>",n+='<div class="user" style="background-image: url('+e.avatar+');">',n+='<span class="nick-name">'+e.nick_name+"</span></div></div>",$(".lottery-right").prepend(n)})}else alert("检测抽奖池没有用户或是用户被其他抽奖功能全部抽完了")}).fail(function(){alert("您断网了，请检查网络连接是否正常")})},getUser=function(n){audio_GetOne&&audio_GetOne.play(),$(".lottery-right").scrollTop(0);var t=$(".lottery-right").scroll(0).children(".result-line").length,a=$ResultSeed.clone();a.find(".result-num").html(t+1),a.prependTo(".lottery-right").slideDown();var o=a.offset();$(".lottery-run").addClass("moving"),$(".lottery-run").removeClass("box-moving"),window.setTimeout(function(){window.setTimeout(function(){$(".lottery-run").removeClass("moving")},1e3);var t=$(".lottery-run .user"),e=t.clone().appendTo("body").css({position:"absolute",top:t.offset().top,left:t.offset().left,width:t.width(),height:t.height()}).addClass("").animate({width:60,height:60,top:o.top+5,left:o.left+50},500,function(){var t=e.css("background-image");e.appendTo(a).removeAttr("style").css({"background-image":t}),$.isFunction(n)&&n.call(this)})},3e3)},start_game=function(){if(parseInt($(".usercount-label").text())<=0)return alert("所有的人都已经抽完了"),!1;(winer_count=1*$("#num").val())<=Players.length?($(".lottery-run").removeClass("moving"),$(".lottery-run").addClass("box-moving"),$(".control.button-run").hide(),flgPlaying=!0,playanimate(),audio_Running&&audio_Running.play(),window.setTimeout(function(){$(".control.button-stop").fadeIn()},500)):alert("计划选"+winer_count+"人，但是只剩"+Players.length+"人可选，请减少选取数！")},stop_game=function(){$(".control.button-stop").hide(),audio_Running&&audio_Running.pause(),$.isArray(Players)?(winer_count=1*$("#num").val())<=Players.length?getWiner():alert("计划选"+winer_count+"人，但是只剩"+Players.length+"人可选，请减少选取数！"):alert("无法获得游戏数据，与游戏服务器断开，请刷新重试！")},winer_count=0,getwinner_status=!1,getWiner=function(){if(0==getwinner_status){flgPlaying=!(getwinner_status=!0),window.clearTimeout(tmr_playanimate);for(var t,e=!1,n=Players.length,a=0;a<n;a++)if(2==Players[a].designated){e=a,t=Players.splice(e,1)[0];break}for(;!1===e;)e=Math.floor(Math.random()*Players.length),3!=Players[e].designated?t=Players.splice(e,1)[0]:e=!1;$.ajax({url:"ajax_act_lottory.php?action=ok",data:{openid:t.openid,awardid:$("select[name=luckTag]").val(),from:"cjx"},type:"post",dataType:"json",async:!0,success:function(t){if(0<t.ret){var e=$("#leftperson").val();e-=1,$("#leftperson").val(e),$(".usercount-label").html(e+"人"),$(".lottery-run .user").css({"background-image":"url("+t.data.avatar+")"}),$(".lottery-run .user .nick-name").html(t.data.nick_name),$(".lottery-run .user .mobile").html(t.data.mobile)}getwinner_status=!1},error:function(){alert("您断网了，请检查网络连接是否正常"),getwinner_status=!1}}),window.setTimeout(function(){getUser(function(){0<--winer_count?(flgPlaying=!0,window.setTimeout(function(){playanimate(),getWiner()},1e3)):$(".control.button-run").fadeIn()})},500)}},curr_index=0,flgPlaying=!1,playanimate=function(){if(Players[curr_index]){var t=Players[curr_index];$(".lottery-run .user").css({"background-image":"url("+t.avatar+")"}),$(".lottery-run .user .nick-name").html(t.nick_name),++curr_index>=Players.length&&(curr_index=0),flgPlaying&&(tmr_playanimate=window.setTimeout(playanimate,100))}};
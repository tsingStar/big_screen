var index=function(){var w=document.getElementById("Audio_Running");var i=document.getElementById("Audio_Result");var h=$(".lottery-side");var O=$(".lottery-bottom");var G=h.find(".btn-left");var K=h.find(".btn-right");var m=h.find(".icon-minus");var C=h.find(".icon-plus");var H=h.find(".lottery-num");var u=O.find(".btn-start");var z=$(".lottery-run .user");var A=lotteryconfig.themeconfig;var t=0;var g=0;var p=null;var l=prizesdata.length;var b=0;var M=0;function n(P){$(".lottery-right").html('<div class="result-line"><div class="result-num">1</div></div>');J(P).done(function(S){if(S.code<0){alert(S.message);return false}else{M=S.data.participants;if(S.data.winners.length>0){var R="";b=S.data.winners.length;p.leftnum=p.num-b;for(var Q=0;Q<b;Q++){R+=f(S.data.winners[Q],b-Q)}$(R).appendTo($(".lottery-right"))}}})}function f(S,Q){var P='<div class="result-line" style="display: block;"><div class="result-num">{{iterator}}</div><div class="user toux3" style="background-image: url(\'{{image}}\'); width: 60px; height: 60px;"><p class="nick-name">{{col1}}</p></div></div>';var R=P;R=R.replace("{{iterator}}",Q);if(S["nick_name"]!=""){R=R.replace("{{col1}}",""+S["nick_name"]+"")}else{R=R.replace("{{col1}}","")}if(S["avatar"]!=undefined&&S["avatar"]!=""){R=R.replace("{{image}}",S["avatar"])}else{R=R.replace("{{image}}","/Modules/Lottery/templates/front/cjx/assets/images/lot_nouser.jpg")}return R}function y(){if(prizesdata.length<=0){alert("请先在后台添加奖项,然后刷新页面哦!");return}for(var Q=0,P=prizesdata.length;Q<P;Q++){prizesdata[Q].totalleft=parseInt(prizesdata[Q].leftnum)+parseInt(prizesdata[Q].freezenum)}t=parseInt(H.text());L(g)}function L(P){p=prizesdata[P];$("#prizedata").text(p.prizename);$(".lottery-img").find("img").attr("src",p.formatedtext.text);n(p.id)}function D(){g=(g+1)%l;d();L(g)}function v(){g=g-1<0?(l-1):(g-1);g=g%l;d();L(g)}function d(){t=1;H.text(t)}function o(){t++;H.text(t)}function x(){t--;t=t<1?1:t;H.text(t)}var j=false;function s(){if(M-t<0){alert("已经没有可以参与抽奖的人了。");return false}if(p.totalleft-t<0){alert("奖品数量不够了，无法进行抽奖。");return false}if(j==true){return false}u.removeClass("btn-start").addClass("btn-stop");u.off("click");u.text("停止");u.fadeOut("slow");e();setTimeout(function(){j=true;u.fadeIn("slow");u.on("click",function(){q()})},2000)}function e(){$(".lottery-run").removeClass("moving");$(".lottery-run").addClass("box-moving");w.play()}function E(){w.pause();$(".lottery-run").removeClass("box-moving")}var B=[];function q(){if(M-t<0){alert("已经没有可以参与抽奖的人了。");return false}if(p.totalleft-t<0){alert("奖品数量不够了，无法进行抽奖。");return false}if(j==false){return false}u.removeClass("btn-stop").addClass("btn-start");u.off("click");u.text("开始抽奖");u.fadeOut("slow");a().done(function(P){if(P.code>0){B=B.concat(P.data);p.totalleft=p.totalleft-P.data.length;E();N();u.on("click",function(){s()})}else{alert(P.message);window.location.reload()}})}function N(){k(B,function(){u.fadeIn("slow");j=false})}$ResultSeed=$(".lottery-right .result-line");function k(S,U){if(S.length<=0){U();return}else{$(".lottery-run").addClass("moving")}var R=S.pop();z.css({"background-image":"url("+R.avatar+")"});z.find(".nick-name").text(R.nick_name);i.play();$(".lottery-right").scrollTop(0);var P=$(".lottery-right").scroll(0).children(".result-line").length;var Q=$ResultSeed.clone();Q.find(".result-num").html((P));Q.prependTo(".lottery-right").slideDown();var T=Q.offset();window.setTimeout(function(){window.setTimeout(function(){$(".lottery-run").removeClass("moving")},500);var V=z.clone().appendTo("body").css({position:"absolute",top:z.offset().top,left:z.offset().left,width:z.width(),height:z.height()}).addClass("").animate({width:60,height:60,top:T.top+5,left:T.left+50},500,function(){var W=V.css("background-image");V.appendTo(Q).removeAttr("style").css({"background-image":W});k(S,U)})},3000)}function I(){G.on("click",function(){v()});K.on("click",function(){D()});m.on("click",function(){x()});C.on("click",function(){o()});u.on("click",function(){s()})}function r(){hotkeys("up",function(P){o()});hotkeys("down",function(P){x()});hotkeys("left",function(P){v()});hotkeys("right",function(P){D()});hotkeys("space",function(P){u.trigger("click")})}function a(){return $.ajax({"url":"/Modules/module.php?m=lottery&c=front&a=ajaxGetLotteryResult","data":{"activityid":configid,"prizeid":p.id,"num":t},"type":"post","dataType":"json"})}function J(P){return $.ajax({"url":"/Modules/module.php?m=lottery&c=front&a=ajaxGetWinners","data":{"activityid":configid,"prizeid":P},"type":"post","dataType":"json"})}function F(){window.sessionStorage["bgpath"]=A.bg_path;window.sessionStorage["bgmusic"]=A.bgmusic_path+"|"+A.bgmusic_switch;if(lotteryconfigs.length>1){var U=[];var T=["","icon3dcj","iconzjd","iconcjx","icon3Dnewcj"];for(var S=0,P=lotteryconfigs.length;S<P;S++){var R=configid==lotteryconfigs[S]["id"]?1:2;U[S]={"name":lotteryconfigs[S]["title"],"action":"/Modules/module.php?m=lottery&c=front&a=index&id="+lotteryconfigs[S]["id"],"icon":T[lotteryconfigs[S]["themeid"]],"current":R}
}window.top.roundbar().init(U)}var Q={};window.top.minibar.init(Q)}function c(){$(".prizename .iconfont").css({"color":A.fontcolor});$(".lottery-control .control-item").css({"color":A.fontcolor});$("#prizedata").css({"color":A.prizefontcolor});$(".result-line .nick-name").css({"color":A.winnerfontcolor});$(".setting-border,.lottery-control").css({"background-color":A.leftcolor})}return{"init":function(){y();I();r();c();F()}}}();$(document).ready(function(){index.init()});
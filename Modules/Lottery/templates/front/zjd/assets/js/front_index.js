var index=function(){var u=document.getElementById("Audio_Running");var h=document.getElementById("Audio_Result");var g=$(".lottery-side");var M=$(".lottery-bottom");var E=g.find(".btn-left");var I=g.find(".btn-right");var l=g.find(".icon-minus");var A=g.find(".icon-plus");var F=g.find(".lottery-num");var s=M.find(".btn-start");var x=$(".lottery-run .user");var r=0;var f=0;var o=null;var k=prizesdata.length;var b=0;var K=0;var y=lotteryconfig.themeconfig;function m(N){$(".lottery-right").html('<div class="result-line"><div class="result-num">1</div></div>');H(N).done(function(Q){if(Q.code<0){alert(Q.message);return false}else{K=Q.data.participants;if(Q.data.winners.length>0){var P="";b=Q.data.winners.length;o.leftnum=o.num-b;for(var O=0;O<b;O++){P+=e(Q.data.winners[O],b-O)}$(P).appendTo($(".lottery-right"));$(".result-line").css({"background-color":y.winnercolor})}}})}function e(Q,O){var N='<div class="result-line" style="display: block;"><div class="result-num">{{iterator}}</div><div class="user toux3" style="background-image: url(\'{{image}}\'); width: 60px; height: 60px;"><p class="nick-name">{{col1}}</p></div></div>';var P=N;P=P.replace("{{iterator}}",O);if(Q["nick_name"]!=""){P=P.replace("{{col1}}",""+Q["nick_name"]+"")}else{P=P.replace("{{col1}}","")}if(Q["avatar"]!=undefined&&Q["avatar"]!=""){P=P.replace("{{image}}",Q["avatar"])}else{P=P.replace("{{image}}","/Modules/Lottery/templates/front/cjx/assets/images/lot_nouser.jpg")}return P}function w(){if(prizesdata.length<=0){alert("请先在后台添加奖项,然后刷新页面哦!");return}for(var O=0,N=prizesdata.length;O<N;O++){prizesdata[O].totalleft=parseInt(prizesdata[O].leftnum)+parseInt(prizesdata[O].freezenum)}r=parseInt(F.text());J(f)}function J(N){o=prizesdata[N];$("#prizedata").text(o.prizename);$(".lottery-img").find("img").attr("src",o.formatedtext.text);m(o.id)}function B(){f=(f+1)%k;d();J(f)}function t(){f=f-1<0?(k-1):(f-1);f=f%k;d();J(f)}function d(){r=1;F.text(r)}function n(){r++;F.text(r)}function v(){r--;r=r<1?1:r;F.text(r)}var i=true;function C(){u.pause();$(".lottery-run").removeClass("box-moving")}var z=[];function p(){if(K-r<0){alert("已经没有可以参与抽奖的人了。");return false}if(o.totalleft-r<0){alert("奖品数量不够了，无法进行抽奖。");return false}if(i==false){return false}i=false;s.removeClass("btn-stop").addClass("btn-start");s.off("click");s.fadeOut("slow");a().done(function(N){if(N.code>0){z=z.concat(N.data);o.totalleft=o.totalleft-N.data.length;C();L();s.on("click",function(){p()})}else{alert(N.message);window.location.reload()}})}function L(){j(z,function(){s.fadeIn("slow");i=true})}$ResultSeed=$(".lottery-right .result-line");function j(Q,S){if(Q.length<=0){S();return}else{$(".lottery-run").addClass("moving")}var P=Q.shift();x.css({"background-image":"url("+P.avatar+")"});x.find(".nick-name").text(P.nick_name);h.play();$(".lottery-right").scrollTop(0);var N=$(".lottery-right").scroll(0).children(".result-line").length;var O=$ResultSeed.clone();O.find(".result-num").html((N));O.prependTo(".lottery-right").slideDown();$(".result-line").css({"background-color":y.winnercolor});var R=O.offset();window.setTimeout(function(){window.setTimeout(function(){$(".lottery-run").removeClass("moving")},500);var T=x.clone().appendTo("body").css({position:"absolute",top:x.offset().top,left:x.offset().left,width:x.width(),height:x.height()}).addClass("").animate({width:60,height:60,top:R.top+5,left:R.left+50},500,function(){var U=T.css("background-image");T.appendTo(O).removeAttr("style").css({"background-image":U});j(Q,S)})},3000)}function G(){E.on("click",function(){t()});I.on("click",function(){B()});l.on("click",function(){v()});A.on("click",function(){n()});s.on("click",function(){p()})}function q(){hotkeys("up",function(N){n()});hotkeys("down",function(N){v()});hotkeys("left",function(N){t()});hotkeys("right",function(N){B()});hotkeys("space",function(N){s.trigger("click")})}function a(){return $.ajax({"url":"/Modules/module.php?m=lottery&c=front&a=ajaxGetLotteryResult","data":{"activityid":configid,"prizeid":o.id,"num":r},"type":"post","dataType":"json"})}function H(N){return $.ajax({"url":"/Modules/module.php?m=lottery&c=front&a=ajaxGetWinners","data":{"activityid":configid,"prizeid":N},"type":"post","dataType":"json"})}function D(){window.sessionStorage["bgpath"]=y.bg_path;window.sessionStorage["bgmusic"]=y.bgmusic_path+"|"+y.bgmusic_switch;if(lotteryconfigs.length>1){var S=[];var R=["","icon3dcj","iconzjd","iconcjx","icon3Dnewcj"];for(var Q=0,N=lotteryconfigs.length;Q<N;Q++){var P=configid==lotteryconfigs[Q]["id"]?1:2;S[Q]={"name":lotteryconfigs[Q]["title"],"action":"/Modules/module.php?m=lottery&c=front&a=index&id="+lotteryconfigs[Q]["id"],"icon":R[lotteryconfigs[Q]["themeid"]],"current":P}}window.top.roundbar().init(S)}var O={};window.top.minibar.init(O)}function c(){$(".prizename .iconfont").css({"color":y.fontcolor});$(".lottery-control .control-item").css({"color":y.fontcolor});$("#prizedata").css({"color":y.prizefontcolor});$(".result-line .nick-name").css({"color":y.winnerfontcolor});
$(".setting-border,.lottery-control").css({"background-color":y.leftcolor})}return{"init":function(){w();G();q();c();D()}}}();$(document).ready(function(){index.init()});
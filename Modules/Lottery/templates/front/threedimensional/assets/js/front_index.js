var index=function(){var J=$("#lottery-panel");var G=J.find(".btn-left");var N=J.find(".btn-right");var m=J.find(".icon-minus");var C=J.find(".icon-plus");var w=J.find(".btn-start");var r=$(".winner-group-pop").find(".btn-pop-close");var I=J.find(".lottery-num");var l=$(".winner-group-pop");var v=0;var h=0;var q=null;var k=prizesdata.length;var b=[];var c=0;var Q=0;var A=lotteryconfig.themeconfig;function z(){if(prizesdata.length<=0){alert("请先在后台添加奖项,然后刷新页面哦!");return}for(var T=0,S=prizesdata.length;T<S;T++){prizesdata[T].totalleft=parseInt(prizesdata[T].leftnum)+parseInt(prizesdata[T].freezenum)}v=parseInt(I.text());O(h)}function O(S){q=prizesdata[S];$("#prizedata").text(q.prizename);$(".lottery-img").find("img").attr("src",q.formatedtext.text);n(q.id)}function n(S){$(".lottery-win-scroll").html("");M(S).done(function(V){if(V.code<0){alert(V.message);return false}else{Q=V.data.participants;c=0;if(V.data.winners.length>0){var U="";c=V.data.winners.length;for(var T=0;T<c;T++){U+=g(V.data.winners[T])}$(U).appendTo($(".lottery-win-scroll"));$(".winner-name").css({"color":A.winnerfontcolor})}$(".winnernum_txt").text(c)}})}function H(T){c++;var S=g(T);$(S).prependTo($(".lottery-win-scroll"));$(".winner-name").css({"color":A.winnerfontcolor});$(".winnernum_txt").text(c)}function g(U){var S='<li><div class="lottery-avatar-bd"><div class="lottery-avatar-bg">{{image}}</div></div><div class="winner-name">{{col1}}</div></li>';var T=S;if(U["nick_name"]!=""){T=T.replace("{{col1}}",""+U["nick_name"]+"")}else{T=T.replace("{{col1}}","")}if(U["avatar"]!=undefined&&U["avatar"]!=""){T=T.replace("{{image}}",'<img src="'+U["avatar"]+'">')}else{T=T.replace("{{image}}",'<img src="/Modules/Lottery/templates/front/threedimensional/assets/images/avatar-primary.png">')}return T}function D(){h=(h+1)%k;e();O(h)}function x(){h=h-1<0?(k-1):(h-1);h=h%k;e();O(h)}function e(){v=1;I.text(v)}function p(){v++;I.text(v)}function y(){v--;v=v<1?1:v;I.text(v)}var i=false;function u(){if(Q-v<0){alert("已经没有可以参与抽奖的人了。");return false}if(q.totalleft-v<0){alert("奖品数量不够了，无法进行抽奖。");return false}if(i==true){return false}J.find(".lottery-right").hide();J.find(".btn-start");w.removeClass("btn-start").addClass("btn-stop");w.off("click");w.hide();P().done(function(T){if(T.code>0){b=T.data;var S=K(b);startanimate(S,A.showstyle);setTimeout(function(){i=true;w.show();w.on("click",function(){s()})},2000)}})}function K(V){var T=new Array;var U=V.length;if(U<=0){return}for(var S=0;S<126;S++){T[S]=new Object();T[S]=V[S%U];T[S].src=V[S%U].thumb_image;T[S].p_x=S%20+1;T[S].p_y=Math.floor(S/20)+1}T=T.sort(function(){return Math.random()});return T}var B=[];function s(){if(Q-v<0){alert("已经没有可以参与抽奖的人了。");return false}if(q.totalleft-v<0){alert("奖品数量不够了，无法进行抽奖。");return false}if(i==false){return false}w.removeClass("btn-stop").addClass("btn-start");w.off("click");a().done(function(S){if(S.code>0){restartanimate();J.find(".lottery-right").show();B=B.concat(S.data);q.totalleft=q.totalleft-S.data.length;R();w.on("click",function(){u()})}else{alert(S.message);window.location.reload()}})}function R(){if(B.length>5){d(B);B=[]}else{j(B,function(S){H(S)},function(){i=false})}}function d(W){var V=l.find(".group-bar ul");V.html("");var U="";for(var T=0,S=W.length;T<S;T++){U=f(W[T])+U;H(W[T])}$(U).prependTo(V);l.show()}function f(U){var S='<li><div class="winner-avatar"><div class="avatar-box">{{image}}</div></div><span class="winner-name">{{col1}}</span></li>';var T=S;if(U["nick_name"]!=""){T=T.replace("{{col1}}",""+U["nick_name"]+"")}else{T=T.replace("{{col1}}","")}if(U["avatar"]!=undefined&&U["avatar"]!=""){T=T.replace("{{image}}",'<img src="'+U["avatar"]+'">')}else{T=T.replace("{{image}}","")}return T}function j(V,W,T){if(V.length<=0){T();return}var U=V.pop();var S=$(".winner-single-pop");S.find(".avatar-contain img").attr("src",U.avatar);S.find(".winer-name").text(U.nick_name);S.css({"opacity":0});S.show();S.animate({"opacity":1},1000,function(){S.fadeOut(1000,function(){W(U);j(V,W,T)})})}function o(){l.hide();i=false}function a(){return $.ajax({"url":"/Modules/module.php?m=lottery&c=front&a=ajaxGetLotteryResult","data":{"activityid":configid,"prizeid":q.id,"num":v},"type":"post","dataType":"json"})}function M(S){return $.ajax({"url":"/Modules/module.php?m=lottery&c=front&a=ajaxGetWinners","data":{"activityid":configid,"prizeid":S},"type":"post","dataType":"json"})}function P(){return $.ajax({"url":"/Modules/module.php?m=lottery&c=front&a=ajaxGetTempUsers","type":"get","dataType":"json"})}function F(){window.sessionStorage["bgpath"]=A.bg_path;window.sessionStorage["bgmusic"]=A.bgmusic_path+"|"+A.bgmusic_switch;if(lotteryconfigs.length>1){var X=[];var W=["","icon3dcj","iconzjd","iconcjx","icon3Dnewcj"];for(var V=0,S=lotteryconfigs.length;V<S;V++){var U=configid==lotteryconfigs[V]["id"]?1:2;X[V]={"name":lotteryconfigs[V]["title"],"action":"/Modules/module.php?m=lottery&c=front&a=index&id="+lotteryconfigs[V]["id"],"icon":W[lotteryconfigs[V]["themeid"]],"current":U}}window.top.roundbar().init(X)
}var T={};window.top.minibar.init(T)}function L(){console.log("bind btns");G.on("click",function(){x()});N.on("click",function(){D()});m.on("click",function(){y()});C.on("click",function(){p()});w.on("click",function(){u()});r.on("click",function(){o()})}function t(){hotkeys("up",function(S){p()});hotkeys("down",function(S){y()});hotkeys("left",function(S){x()});hotkeys("right",function(S){D()});hotkeys("space",function(S){w.trigger("click")})}function E(){$(".lottery-left").css({"background-color":A.leftcolor});$(".lottery-right").css({"background-color":A.rightcolor});$(".prizename,.control-item,.winnernum").css({"color":A.fontcolor});$(".winner-name").css({"color":A.winnerfontcolor});$("#prizedata").css({"color":A.prizefontcolor})}return{"init":function(){z();L();t();E();F()}}}();$(document).ready(function(){index.init()});
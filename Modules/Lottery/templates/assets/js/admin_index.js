var admin_index=function(){var e=$("#btn-openmodaladdlotteryconfig"),a=$(".btn-addlotteryconfig"),t=$(".btn-lotteryconfig"),n=$(".btn-dellotteryconfig"),i=$("#btn-showprizes"),d=$("#btn-showwinners"),o=$("#btn-showdesignated"),r=$("#btn-themesettings"),l=$(".btn-savelotteryconfig"),c=$("#addlotteryconfigmodal");function s(){e.on("click",function(){$("#addlotteryconfigmodal").modal("show")}),a.on("click",function(){var e={id:0};e.title=c.find("input[name=title]").val(),e.themeid=c.find("select[name=themeid]").val(),e.winagain=c.find("input[name=winagain]:checked").val()?2:1,e.showtype=c.find("input[name=showtype]:checked").val(),p(e).done(function(e){0<e.code?window.location.href="/Modules/module.php?m=lottery&c=admin&a=index&id="+e.data.id:alert(e.message)})}),l.on("click",function(){var e={},a=$("#lotteryconfig");e.id=a.find("input[name=id]").val(),e.title=a.find("input[name=title]").val(),e.themeid=a.find("select[name=themeid]").val(),e.winagain=a.find("input[name=winagain]:checked").val()?2:1,e.showtype=a.find("input[name=showtype]:checked").val(),p(e).done(function(e){0<e.code?window.location.href="/Modules/module.php?m=lottery&c=admin&a=index&id="+e.data.id:alert(e.message)})}),t.on("click",function(){var e=$(this).attr("data-id");window.location.href="/Modules/module.php?m=lottery&c=admin&a=index&id="+e}),n.on("click",function(){if(!confirm("确认要删除这轮抽奖吗?"))return!1;(function(e){return $.ajax({url:"/Modules/module.php?m=lottery&c=admin&a=ajaxDelLotteryConfig",type:"post",data:{id:e},dataType:"json"})})($(this).attr("data-id")).done(function(e){0<e.code?window.location.href="/Modules/module.php?m=lottery&c=admin&a=index":alert(e.message)})}),i.on("click",function(){if($(this).parent().hasClass("active"))return!1;var a=$(this).attr("data-id"),t=$(this).attr("href");$(t).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>'),u(a).done(function(e){$(t).html(e),admin_snippets_prizes(a).init()})}),d.on("click",function(){if($(this).parent().hasClass("active"))return!1;var a=$(this).attr("data-id"),t=$(this).attr("href");$(t).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>'),m(a).done(function(e){$(t).html(e),admin_snippets_winners(a).init()})}),o.on("click",function(){if($(this).parent().hasClass("active"))return!1;var a=$(this).attr("data-id"),t=$(this).attr("href");$(t).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>'),f(a).done(function(e){$(t).html(e),admin_snippets_designated(a).init()})}),r.on("click",function(){if($(this).parent().hasClass("active"))return!1;var a=$(this).attr("data-id"),t=$(this).attr("href");$(t).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>'),g(a).done(function(e){$(t).html(e),admin_snippets_themesettings(a).init()})})}function p(e){return e.id||(e.id=0),$.ajax({url:"/Modules/module.php?m=lottery&c=admin&a=ajaxSaveLotteryConfig",type:"post",data:e,dataType:"json"})}function u(e){return $.ajax({url:"/Modules/module.php?m=lottery&c=admin&a=ajaxGetPrizes",type:"post",data:{id:e},dataType:"text"})}function m(e){return $.ajax({url:"/Modules/module.php?m=lottery&c=admin&a=ajaxGetWinners",type:"post",data:{id:e},dataType:"text"})}function f(e){return $.ajax({url:"/Modules/module.php?m=lottery&c=admin&a=ajaxGetDesignated",type:"post",data:{id:e},dataType:"text"})}function g(e){return $.ajax({url:"/Modules/module.php?m=lottery&c=admin&a=ajaxGetThemeSettings",type:"post",data:{id:e},dataType:"text"})}return{init:function(){s()},reloadTab:function(a,t){switch($(a).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>'),a){case"#prizes":u(t).done(function(e){$(a).html(e),admin_snippets_prizes(t).init()});break;case"#winners":m(t).done(function(e){$(a).html(e),admin_snippets_winners(t).init()});break;case"#designated":f(t).done(function(e){$(a).html(e),admin_snippets_designated(t).init()});break;case"#lotterytheme":g(t).done(function(e){$(a).html(e),admin_snippets_themesettings(t).init()})}}}}(),admin_snippets_prizes=function(t){var n=$("#editprizemodal"),i='<div class="space-4"></div>    <div class="row">        <div class="form-group">            <label class="col-xs-4" style="text-align: right;">奖品名称：</label>            <div>                <input type="text"  name="prizename"  class="col-xs-5" value="" />            </div>        </div>    </div>    <div class="space-4"></div>    <div class="row">        <div class="form-group">            <label class="col-xs-4" style="text-align: right;">剩余数量：</label>            <div>                <input type="number"  name="num"  class="col-xs-5" value="1" />            </div>        </div>    </div>    <div class="space-4"></div>    <div class="row">        <div class="form-group">            <label class="col-xs-4" style="text-align: right;">奖品类型：</label>            <div>                <select name="type">                <option value="1">普通奖品</option>                <option value="3">微信红包</option>                </select>            </div>        </div>    </div>    <div id="prizetype"></div>',d='<div class="space-4"></div><div class="row"><div class="form-group"><label class="col-xs-4" style="text-align: right;">奖品图片：</label><div class="col-md-8" style="padding-left:0px;"><input type="file" class="imageuploader" name="imagepath"/><input type="hidden"  name="imageid" value="0"/></div></div>',o='<div class="row">    <div class="form-group">        <label class="col-xs-4" style="text-align: right;">金额(元)：</label>        <div>            <input type="number"  name="amount"  class="col-xs-5" value="1"  min="1" max="200"/>        </div>    </div></div>',e=$(".btn-openaddprizemodal"),a=$(".btn-save"),r=$(".btn-delete");function l(e){var a={id:0,prizename:"",activityid:t,type:1,imageid:0,leftnum:1};e<=0?c(a):function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajax_act_get_prize",type:"post",data:{id:e},dataType:"json"})}(e).done(function(e){0<e.code?c(e.data):(alert(e.message),c(a))}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")}),$("#editprizemodal").modal("show")}function c(e){n.find(".columnitems").html(""),$(i).appendTo(n.find(".columnitems")),n.find("input[name=id]").val(e.id),n.find("input[name=activityid]").val(e.activityid),n.find("input[name=prizename]").val(e.prizename),n.find("input[name=num]").val(e.leftnum),n.find("select[name=type]").val(e.type);var a=n.find("select[name=type]");a.off("change"),a.on("change",function(){e.type=$(this).val(),s(e)}),s(e)}function s(e){$("#prizetype").html(""),1==e.type&&function(e){$(d).appendTo("#prizetype"),$(".imageuploader").ace_file_input({style:"well",btn_choose:"点击此处选择图片",btn_change:null,no_icon:"ace-icon fa fa-cloud-upload",droppable:!0,maxSize:55e4,allowExt:["jpeg","jpg","png","gif"],allowMime:["image/jpg","image/jpeg","image/png","image/gif"],thumbnail:"large",previewHeight:200,preview_error:function(e,a){console.log(a)},before_remove:function(){return $("input[name=imageid]").val(0),!0}}).on("change",function(){$("input[name=imageid]").val(0)}).on("file.error.ace",function(e,a){}),0<e.id&&0<e.prizedata_arr.imageid&&($("input[name=imageid]").val(e.prizedata_arr.imageid),$("input[name=imagepath]").ace_file_input("show_file_list",[{type:"image",name:"奖品图",path:e.formatedtext.text}]))}(e),3==e.type&&function(e){$(o).appendTo("#prizetype"),$(d).appendTo("#prizetype"),$(".imageuploader").ace_file_input({style:"well",btn_choose:"点击此处选择图片",btn_change:null,no_icon:"ace-icon fa fa-cloud-upload",droppable:!0,maxSize:55e4,allowExt:["jpeg","jpg","png","gif"],allowMime:["image/jpg","image/jpeg","image/png","image/gif"],thumbnail:"large",previewHeight:200,preview_error:function(e,a){console.log(a)},before_remove:function(){return $("input[name=imageid]").val(0),!0}}).on("change",function(){$("input[name=imageid]").val(0)}).on("file.error.ace",function(e,a){}),0<e.id&&0<e.prizedata_arr.imageid&&($("input[name=imageid]").val(e.prizedata_arr.imageid),$("input[name=imagepath]").ace_file_input("show_file_list",[{type:"image",name:"奖品图",path:e.formatedtext.text}]));var a=(e.prizedata_arr.amount/100).toFixed(2);$("input[name=amount]").val(a)}(e)}function p(){e.on("click",function(){l($(this).attr("data-id"))}),a.on("click",function(){return function(){var a=n.find("input[name=activityid]").val();$("#editform").ajaxSubmit({dataType:"json",success:function(e){0<e.code?admin_index.reloadTab("#prizes",a):alert(e.message)}})}(),$("#editprizemodal").modal("hide"),!1}),r.on("click",function(){if(!confirm("确认要删除这个奖项吗?"))return!1;var a=$(this).attr("data-id");(function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajax_act_delete_prize",data:{id:e},type:"get",dataType:"json"})})(a).done(function(e){0<e.code?$("#item_"+a).remove():alert(e.message)})})}return{init:function(){p()}}},admin_snippets_winners=function(a){var e=$("#widget-box-winners"),t=e.find(".btn-clear"),n=e.find(".btn-give"),i=e.find(".btn-cancel"),d=e.find(".btn-delete"),o=e.find(".btn-exportexcel"),r=e.find(".btn-redpacket");function l(){o.on("click",function(){window.open("/Modules/module.php?m=prize&c=admin&a=exportdata&plugname=lottery")}),t.on("click",function(){if(!confirm("确认要清空中奖记录吗?"))return!1;(function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajax_act_cleardata",type:"get",dataType:"json",data:{plugname:"lottery",activityid:e}})})(a).done(function(e){console.log(a),admin_index.reloadTab("#winners",a)})}),n.on("click",function(){n.off("click"),function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajax_act_give_userprize",data:{id:e},type:"get",dataType:"json"})}($(this).attr("data-id")).done(function(e){alert(e.message),0<e.code&&admin_index.reloadTab("#winners",a)}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})}),i.on("click",function(){(function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajax_act_cancel_userprize",data:{id:e},type:"get",dataType:"json"})})($(this).attr("data-id")).done(function(e){alert(e.message),0<e.code&&admin_index.reloadTab("#winners",a)}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})}),d.on("click",function(){var e=$(this).attr("data-id");if(!confirm("确认要删除这条中奖记录吗?"))return!1;(function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajax_act_delete_userprize",data:{id:e},type:"get",dataType:"json"})})(e).done(function(e){alert(e.message),0<e.code&&admin_index.reloadTab("#winners",a)}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})}),r.on("click",function(){(function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajaxGetSendRedpackets",data:{id:e},type:"get",dataType:"json"})})($(this).attr("data-id")).done(function(e){if(0<e.code){$(".sendredpacketstatus").html("");var a=function(e){if(e.length<=0)return;var a="<table class='table table-striped table-bordered table-hover'>";a+="<tr><td>订单号</td><td>状态</td><td>时间</td><td>备注</td></tr>";for(var t=0,n=e.length;t<n;t++){var i="";"开始发放"==e[t].status&&(i="开始发放"),"发放完成"==e[t].status&&(i="发放完成"),"发放失败"==e[t].status&&(i=0==t?'发放失败<a href="###" class="resend" data-orderno="'+e[t].orderno+'">重新发</a>':"发放失败"),"等待微信处理中"==e[t].status&&(i='等待微信处理中<a href="###" class="checkstatus" data-orderno="'+e[t].orderno+'">获取最新状态</a>'),a+="<tr><td>"+e[t].orderno+"</td><td>"+i+"</td><td>"+e[t].created_at+"</td><td>"+e[t].remark+"</td></tr>"}return a+="</table>"}(e.data);$(a).appendTo(".sendredpacketstatus"),$(".resend").on("click",function(){var e=$(this).attr("data-orderno");(function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajaxResendRedpacket",data:{orderno:e},type:"get",dataType:"json"})})(e).done(function(e){alert(e.message),0<e.code&&$("#redpacketsmodal").modal("hide")})}),$(".checkstatus").on("click",function(){var e=$(this).attr("data-orderno");(function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajaxCheckRedpacket",data:{orderno:e},type:"get",dataType:"json"})})(e).done(function(e){alert(e.message),0<e.code&&$("#redpacketsmodal").modal("hide")})}),$("#redpacketsmodal").modal("show")}})})}return{init:function(){l()}}},admin_snippets_designated=function(n){var i=$("#widget-box-designated"),e=i.find(".btn-openmodaladddesignated"),a=i.find(".btn-cancel"),t=i.find(".btn-search"),d=i.find(".btn-save");function o(){e.on("click",function(){i.find(".search-query").val(""),i.find("select[name=userid]").html('<option value="0">无数据</option>'),i.find("select[name=prizeid]").val(0),i.find("select[name=designated]").val(2),i.find("#designatedmmodal").modal("show")}),a.on("click",function(){if(!confirm("确认要删除这条内定记录吗?"))return!1;var a=$(this).attr("data-id");(function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajax_act_cancel_designated",data:{id:e},type:"get",dataType:"json"})})(a).done(function(e){alert(e.message),0<e.code&&$("#designated_"+a).remove()}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})}),t.on("click",function(){(function(e){return $.ajax({url:"module.php?m=prize&c=admin&a=ajax_act_get_users",data:{searchtext:e},type:"get",dataType:"json"})})(i.find(".search-query").val()).done(function(e){if(0<e.code){var a="",t=e.data.length;if(0<t)for(var n=0;n<t;n++)a+='<option value="'+e.data[n].id+'">昵称:'+e.data[n].nickname+" 姓名："+e.data[n].signname+" 电话："+e.data[n].phone+"</option>",console.log(e.data[n]);else a='<option value="0">无数据</option>';i.find("select[name=userid]").html(a)}""!=e.message?i.find("#userid-help-block").html('<i class="ace-icon fa fa-exclamation-triangle red"></i>'+e.message):i.find("#userid-help-block").html("")}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})}),d.on("click",function(){var e=$("select[name=userid]").val(),a=$("select[name=prizeid]").val(),t=$("select[name=designated]").val();return 0==e?(alert("必须选择一个人进行内定"),!1):0==a?(alert("必须选择一个奖品进行内定"),!1):void function(e,a,t,n,i){var d=$(".roundlist .green .btn-lotteryconfig").text();return $.ajax({url:"module.php?m=prize&c=admin&a=ajax_act_save_designated",data:{userid:e,prizeid:a,designated:t,plugname:n,activityid:i,title:d},type:"get",dataType:"json"})}(e,a,t,"lottery",n).done(function(e){alert(e.message),0<e.code&&(i.find("#designatedmmodal").modal("hide"),admin_index.reloadTab("#designated",n))}).fail(function(){return alert("请检查您的网络，有可能是断网了哦。"),!1})})}return{init:function(){o()}}};$(document).ready(function(){admin_index.init()});
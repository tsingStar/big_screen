var admin_index=function(){var btn_openmodaladdimportlotteryconfig=$("#btn-openmodaladdimportlotteryconfig");var btn_addlotteryconfig=$(".btn-addlotteryconfig");var btn_lotteryconfig=$(".btn-lotteryconfig");var btn_dellotteryconfig=$(".btn-dellotteryconfig");var btn_showprizes=$("#btn-showprizes");var btn_showimportdata=$("#btn-showimportdata");var btn_showwinners=$("#btn-showwinners");var btn_showdesignated=$("#btn-showdesignated");var btn_themesettings=$("#btn-themesettings");var btn_savelotteryconfig=$(".btn-savelotteryconfig");var add_modal=$("#addimportlotteryconfigmodal");function bindBtn(){btn_openmodaladdimportlotteryconfig.on("click",function(){$("#addimportlotteryconfigmodal").modal("show")});btn_addlotteryconfig.on("click",function(){var data={};data.id=0;data.title=add_modal.find("input[name=title]").val();data.themeid=add_modal.find("select[name=themeid]").val();ajaxSaveLotteryConfig(data).done(function(json){if(json.code>0){window.location.href="/Modules/module.php?m=importlottery&c=admin&a=index&id="+json.data.id}else{alert(json.message)}})});btn_savelotteryconfig.on("click",function(){var data={};var form=$("#lotteryconfig");data.id=form.find("input[name=id]").val();data.title=form.find("input[name=title]").val();data.themeid=form.find("select[name=themeid]").val();ajaxSaveLotteryConfig(data).done(function(json){if(json.code>0){window.location.href="/Modules/module.php?m=importlottery&c=admin&a=index&id="+json.data.id}else{alert(json.message)}})});btn_lotteryconfig.on("click",function(){var id=$(this).attr("data-id");window.location.href="/Modules/module.php?m=importlottery&c=admin&a=index&id="+id});btn_dellotteryconfig.on("click",function(){if(!confirm("确认要删除这轮抽奖吗?")){return false}var id=$(this).attr("data-id");ajaxDelLotteryConfig(id).done(function(json){if(json.code>0){window.location.href="/Modules/module.php?m=importlottery&c=admin&a=index"}else{alert(json.message)}})});btn_showprizes.on("click",function(){if($(this).parent().hasClass("active")){return false}var id=$(this).attr("data-id");var tabid=$(this).attr("href");$(tabid).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');ajaxGetPrizes(id).done(function(text){$(tabid).html(text);var prizespage=admin_snippets_prizes(id);prizespage.init()})});btn_showimportdata.on("click",function(){if($(this).parent().hasClass("active")){return false}var id=$(this).attr("data-id");var tabid=$(this).attr("href");$(tabid).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');ajaxGetImportData(id).done(function(text){$(tabid).html(text);var importdatapage=admin_snippets_importdata(id);importdatapage.init()})});btn_showwinners.on("click",function(){if($(this).parent().hasClass("active")){return false}var id=$(this).attr("data-id");var tabid=$(this).attr("href");$(tabid).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');ajaxGetWinners(id).done(function(text){$(tabid).html(text);var winnerspage=admin_snippets_winners(id);winnerspage.init()})});btn_showdesignated.on("click",function(){if($(this).parent().hasClass("active")){return false}var id=$(this).attr("data-id");var tabid=$(this).attr("href");$(tabid).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');ajaxGetDesignated(id).done(function(text){$(tabid).html(text);var designatedpage=admin_snippets_designated(id);designatedpage.init()})});btn_themesettings.on("click",function(){if($(this).parent().hasClass("active")){return false}var id=$(this).attr("data-id");var tabid=$(this).attr("href");$(tabid).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');ajaxGetThemeSettings(id).done(function(text){$(tabid).html(text);var themesettingspage=admin_snippets_themesettings(id);themesettingspage.init()})})}function ajaxSaveLotteryConfig(data){if(!data.id){data.id=0}return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxSaveLotteryConfig","type":"post","data":data,"dataType":"json",})}function ajaxDelLotteryConfig(id){return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxDelLotteryConfig","type":"post","data":{"id":id},"dataType":"json",})}function ajaxGetPrizes(id){return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxGetPrizes","type":"post","data":{"id":id},"dataType":"text",})}function ajaxGetImportData(id){return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxGetImportData","type":"post","data":{"id":id},"dataType":"text",})}function ajaxGetWinners(id){return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxGetWinners","type":"post","data":{"id":id},"dataType":"text",})}function ajaxGetDesignated(id){return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxGetDesignated","type":"post","data":{"id":id},"dataType":"text",})}function ajaxGetThemeSettings(id){return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxGetThemeSettings","type":"post","data":{"id":id},"dataType":"text",})}return{"init":function(){bindBtn()
},"reloadTab":function(tabid,id){$(tabid).html('<i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');switch(tabid){case"#prizes":ajaxGetPrizes(id).done(function(text){$(tabid).html(text);var prizespage=admin_snippets_prizes(id);prizespage.init()});break;case"#importdata":ajaxGetImportData(id).done(function(text){$(tabid).html(text);var importdatapage=admin_snippets_importdata(id);importdatapage.init()});break;case"#winners":ajaxGetWinners(id).done(function(text){$(tabid).html(text);var winnerspage=admin_snippets_winners(id);winnerspage.init()});break;case"#designated":ajaxGetDesignated(id).done(function(text){$(tabid).html(text);var designatedpage=admin_snippets_designated(id);designatedpage.init()});break;case"#lotterytheme":ajaxGetThemeSettings(id).done(function(text){$(tabid).html(text);var themesettingspage=admin_snippets_themesettings(id);themesettingspage.init()});break}}}}();var admin_snippets_prizes=function(activityid){var formEl=$("#editprizemodal");var default_itemtemplate='<div class="space-4"></div>    <div class="row">        <div class="form-group">            <label class="col-xs-4" style="text-align: right;">奖品名称：</label>            <div>                <input type="text"  name="prizename"  class="col-xs-5" value="" />            </div>        </div>    </div>    <div class="space-4"></div>    <div class="row">        <div class="form-group">            <label class="col-xs-4" style="text-align: right;">剩余数量：</label>            <div>                <input type="number"  name="num"  class="col-xs-5" value="1" />            </div>        </div>    </div>';var img_itemtemplate='<div class="space-4"></div><div class="row"><div class="form-group"><label class="col-xs-4" style="text-align: right;">奖品图片：</label><div class="col-md-8" style="padding-left:0px;"><input type="file" class="imageuploader" name="imagepath"/><input type="hidden"  name="imageid" value="0"/></div></div>';var btn_openaddprizemodal=$(".btn-openaddprizemodal");var btn_save=formEl.find(".btn-save");var btn_delete=$(".btn-delete");function openform(id){var defautdata={"id":0,"prizename":"","activityid":activityid,"type":1,"imageid":0,"leftnum":1,};if(id<=0){fillform(defautdata)}else{ajax_get_prize(id).done(function(json){if(json.code>0){fillform(json.data)}else{alert(json.message);fillform(defautdata)}}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})}$("#editprizemodal").modal("show")}function fillform(data){formEl.find(".columnitems").html("");$(default_itemtemplate).appendTo(formEl.find(".columnitems"));formEl.find("input[name=id]").val(data.id);formEl.find("input[name=activityid]").val(data.activityid);formEl.find("input[name=prizename]").val(data.prizename);formEl.find("input[name=num]").val(data.leftnum);genformitem(data)}function genformitem(data){if(data.type==1){genprizenormalitem(data)}}function genprizenormalitem(data){$(img_itemtemplate).appendTo(".columnitems");$(".imageuploader").ace_file_input({style:"well",btn_choose:"点击此处选择图片",btn_change:null,no_icon:"ace-icon fa fa-cloud-upload",droppable:true,maxSize:550000,allowExt:["jpeg","jpg","png","gif"],allowMime:["image/jpg","image/jpeg","image/png","image/gif"],thumbnail:"large",previewHeight:200,preview_error:function(filename,error_code){console.log(error_code)},before_remove:function(){$("input[name=imageid]").val(0);return true}}).on("change",function(){$("input[name=imageid]").val(0)}).on("file.error.ace",function(e,errors){});if(data.id>0){if(data.prizedata_arr.imageid>0){$("input[name=imageid]").val(data.prizedata_arr.imageid);$("input[name=imagepath]").ace_file_input("show_file_list",[{type:"image",name:"奖品图",path:data.formatedtext.text},])}}}function ajax_get_prize(id){return $.ajax({"url":"module.php?m=prize&c=admin&a=ajax_act_get_prize","type":"post","data":{"id":id},"dataType":"json",})}function ajax_act_delete_prize(id){return $.ajax({"url":"module.php?m=prize&c=admin&a=ajax_act_delete_prize","data":{"id":id},"type":"get","dataType":"json",})}function ajax_act_save_prize(){var activityid=formEl.find("input[name=activityid]").val();$("#editform").ajaxSubmit({dataType:"json",success:function(json){if(json.code>0){admin_index.reloadTab("#prizes",activityid)}else{alert(json.message)}}})}function bindBtn(){btn_openaddprizemodal.on("click",function(){var id=$(this).attr("data-id");openform(id)});btn_save.on("click",function(){console.log(1);ajax_act_save_prize();$("#editprizemodal").modal("hide");return false});btn_delete.on("click",function(){if(!confirm("确认要删除这个奖项吗?")){return false}var id=$(this).attr("data-id");ajax_act_delete_prize(id).done(function(json){if(json.code>0){$("#item_"+id).remove()}else{alert(json.message)}})})}return{"init":function(){bindBtn()}}};var admin_snippets_importdata=function(activityid){var widget_box_importdata=$("#widget-box-importdata");var btn_clear=widget_box_importdata.find(".btn-clear");var btn_importexcel=widget_box_importdata.find(".btn-importexcel");var btn_edit=null;var btn_delete=null;var btn_add=widget_box_importdata.find(".btn-add");
var detailmodal=$("#detailmodal");var btn_save_item=detailmodal.find(".btn-save-item");var importmodal=$("#importdatamodal");var btn_save=importmodal.find(".btn-save");$("input[name=activityid]").val(activityid);function bindBtn(){btn_importexcel.on("click",function(){importmodal.modal("show")});btn_add.on("click",function(){var id=importmodal.find("input[name=id]").val();importmodal.find("input[name=activityid]").val(activityid);id=parseInt(id);if(id<=0){id=0}ajaxGetDetail(id).done(function(json){detailmodal.modal("show")})});btn_save.on("click",function(event){event.preventDefault();ajaxGetImportDataPage()});btn_save_item.on("click",function(event){event.preventDefault();ajaxSaveDetail(activityid)});btn_clear.on("click",function(){if(!confirm("确认要清空导入的数据吗？")){return false}ajaxClearActivityData().done(function(json){admin_index.reloadTab("#importdata",activityid)})})}function bindTableBtns(){btn_edit=widget_box_importdata.find(".btn-edit");btn_delete=widget_box_importdata.find(".btn-delete");btn_edit.on("click",function(){var id=$(this).attr("data-id");ajaxGetDetail(id).done(function(json){if(json.code>0){var inputs=$('input[name="col[]"]');$(inputs[0]).val(json.data.row.datarow[0]);$(inputs[1]).val(json.data.row.datarow[1]);$(inputs[2]).val(json.data.row.datarow[2]);$("input[name=imgid]").val(json.data.row.imgid);if(json.data.row.imgid>0){detailmodal.find("input[name=img]").ace_file_input("show_file_list",[{type:"image",name:"图片",path:json.data.row.imagepath},])}detailmodal.find("input[name=id]").val(id)}detailmodal.modal("show")})});btn_delete.on("click",function(){if(!confirm("确认要删除这个信息吗？")){return false}var id=$(this).attr("data-id");ajaxDelDetail(id).done(function(json){if(json.code>0){admin_index.reloadTab("#importdata",activityid)}else{alert(json.message)}})})}function initData(){ajaxGetPagedData(0);$(".imageuploader").ace_file_input({style:"well",btn_choose:"点击此处选择图片",btn_change:null,no_icon:"ace-icon fa fa-cloud-upload",droppable:true,maxSize:550000,allowExt:["jpeg","jpg","png","gif"],allowMime:["image/jpg","image/jpeg","image/png","image/gif"],thumbnail:"large",previewHeight:200,preview_error:function(filename,error_code){console.log(error_code)},before_remove:function(){$("input[name=imgid]").val(0);return true}}).on("change",function(){$("input[name=imgid]").val(0)}).on("file.error.ace",function(e,errors){})}function ajaxClearActivityData(){return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxClearActivityData","data":{"activityid":activityid},"type":"get","dataType":"json",})}function ajaxGetDetail(id){return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxGetDetail","data":{"activityid":activityid,"id":id},"type":"get","dataType":"json",})}function ajaxDelDetail(id){return $.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxDelDetail","data":{"activityid":activityid,"id":id},"type":"get","dataType":"json",})}function ajaxSaveDetail(activityid){$("#saveitemform").ajaxSubmit({dataType:"json",success:function(json){if(json.code>0){detailmodal.modal("hide");admin_index.reloadTab("#importdata",activityid)}else{alert(json.message)}}})}function pagebtns(){$(".pagination .pagebtn").on("click",function(){var pageno=$(this).attr("pageno");ajaxGetPagedData(pageno)})}function ajaxGetPagedData(page){$.ajax({"url":"/Modules/module.php?m=importlottery&c=admin&a=ajaxGetImportDataPage","data":{"activityid":activityid,"page":page},"type":"get","dataType":"text","success":function(response){$("#datalist").html(response);pagebtns();bindTableBtns()}})}function ajaxGetImportDataPage(){var file=$("input[name=fileexcel]").val();if(!file){alert("您还没有选择文件哦");return false}$("#importform").ajaxSubmit({dataType:"json",success:function(json){if(json.code>0){$("#importdatamodal").modal("hide");admin_index.reloadTab("#importdata",activityid)}else{alert(json.message)}}})}return{"init":function(){bindBtn();initData()}}};var admin_snippets_winners=function(activityid){var wiget_box_winners=$("#widget-box-winners");var btn_clear=wiget_box_winners.find(".btn-clear");var btn_give=wiget_box_winners.find(".btn-give");var btn_cancel=wiget_box_winners.find(".btn-cancel");var btn_delete=wiget_box_winners.find(".btn-delete");var btn_exportexcel=wiget_box_winners.find(".btn-exportexcel");function bindBtn(){btn_exportexcel.on("click",function(){window.open("/Modules/module.php?m=importlottery&c=admin&a=exportdata")});btn_clear.on("click",function(){if(!confirm("确认要清空中奖记录吗?")){return false}ajaxClearData(activityid).done(function(json){admin_index.reloadTab("#winners",activityid)})});btn_give.on("click",function(){var id=$(this).attr("data-id");ajaxGiveUserPrize(id).done(function(json){alert(json.message);if(json.code>0){admin_index.reloadTab("#winners",activityid)}return}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})});btn_cancel.on("click",function(){var id=$(this).attr("data-id");ajaxCancelUserPrize(id).done(function(json){alert(json.message);if(json.code>0){admin_index.reloadTab("#winners",activityid)
}return}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})});btn_delete.on("click",function(){var id=$(this).attr("data-id");if(!confirm("确认要删除这条中奖记录吗?")){return false}ajaxDeleteUserPrize(id).done(function(json){alert(json.message);if(json.code>0){admin_index.reloadTab("#winners",activityid)}return}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})})}function ajaxCancelUserPrize(id){return $.ajax({"url":"module.php?m=prize&c=admin&a=ajax_act_cancel_userprize","data":{"id":id},"type":"get","dataType":"json",})}function ajaxDeleteUserPrize(id){return $.ajax({"url":"module.php?m=prize&c=admin&a=ajax_act_delete_userprize","data":{"id":id},"type":"get","dataType":"json",})}function ajaxGiveUserPrize(id){return $.ajax({"url":"module.php?m=prize&c=admin&a=ajax_act_give_userprize","data":{"id":id},"type":"get","dataType":"json",})}function ajaxClearData(activityid){return $.ajax({"url":"module.php?m=prize&c=admin&a=ajax_act_cleardata","type":"get","dataType":"json","data":{"plugname":"importlottery","activityid":activityid}})}return{"init":function(){bindBtn()}}};var admin_snippets_designated=function(activityid){var widget_box_designated=$("#widget-box-designated");var btn_openmodaladddesignated=widget_box_designated.find(".btn-openmodaladddesignated");var btn_cancel=widget_box_designated.find(".btn-cancel");var btn_search=widget_box_designated.find(".btn-search");var btn_save=widget_box_designated.find(".btn-save");function bindBtn(){btn_openmodaladddesignated.on("click",function(){widget_box_designated.find(".search-query").val("");widget_box_designated.find("select[name=userid]").html('<option value="0">无数据</option>');widget_box_designated.find("select[name=prizeid]").val(0);widget_box_designated.find("select[name=designated]").val(2);widget_box_designated.find("#designatedmmodal").modal("show")});btn_cancel.on("click",function(){if(!confirm("确认要删除这条内定记录吗?")){return false}var id=$(this).attr("data-id");ajaxCancelDesignated(id).done(function(json){alert(json.message);if(json.code>0){$("#designated_"+id).remove()}}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})});btn_search.on("click",function(){var $searchtext=widget_box_designated.find(".search-query").val();ajaxGetUsers($searchtext).done(function(json){if(json.code>0){console.log(json.data);var options="";var len=json.data.length;if(len>0){for(var i=0;i<len;i++){options+='<option value="'+json.data[i].id+'">'+json.data[i].datarow+"</option>"}}else{options='<option value="0">无数据</option>'}widget_box_designated.find("select[name=userid]").html(options)}return}).fail(function(message){console.log(message);alert("请检查您的网络，有可能是断网了哦。")})});btn_save.on("click",function(){var userid=$("select[name=userid]").val();var prizeid=$("select[name=prizeid]").val();var designated=$("select[name=designated]").val();var plugname="importlottery";if(userid==0){alert("必须选择一个人进行内定");return false}if(prizeid==0){alert("必须选择一个奖品进行内定");return false}ajaxSaveDesignated(userid,prizeid,designated,plugname,activityid).done(function(json){alert(json.message);if(json.code>0){widget_box_designated.find("#designatedmmodal").modal("hide");admin_index.reloadTab("#designated",activityid)}}).fail(function(){alert("请检查您的网络，有可能是断网了哦。");return false})})}function ajaxSaveDesignated(userid,prizeid,designated,plugname,activityid){var roundname=$(".roundlist .green .btn-lotteryconfig").text();return $.ajax({"url":"module.php?m=prize&c=admin&a=ajax_act_save_designated","data":{"userid":userid,"prizeid":prizeid,"designated":designated,"plugname":plugname,"activityid":activityid,"title":roundname},"type":"get","dataType":"json",})}function ajaxGetUsers($searchtext){return $.ajax({"url":"module.php?m=importlottery&c=admin&a=ajaxSearchData","data":{"searchtext":$searchtext},"type":"get","dataType":"json",})}function ajaxCancelDesignated(id){return $.ajax({"url":"module.php?m=prize&c=admin&a=ajax_act_cancel_designated","data":{"id":id},"type":"get","dataType":"json",})}return{"init":function(){bindBtn()}}};$(document).ready(function(){admin_index.init()});
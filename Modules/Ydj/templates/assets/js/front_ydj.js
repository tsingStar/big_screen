$(function(){Game().init();navbtns.init()});var statesessionname="ydj";var lastgamestatus=ROUNDINFO.status;var Game=function(){initRotateBg();$(".screen_show").css("opacity","1");var frequency=500;var getdataframe=2;var counter=0;var firsttime=false;function checkingStatus(){var state=window.sessionStorage[statesessionname];if(state=="start"){window.sessionStorage[statesessionname]="idle";start()}if(state=="reset"){window.sessionStorage[statesessionname]="idle";reset()}if(counter==0){ajaxGetData().done(function(json){if(json.code>0){if(firsttime==false){firsttime=true;ROUNDINFO=json.data.config;init();return}if(json.data.config.status!=ROUNDINFO.status){ROUNDINFO=json.data.config;init(json.data.data)}else{processdata(json.data.data)}}else{alert(json.message)}})}counter++;if(counter%getdataframe==0){counter=0}setTimeout(checkingStatus,frequency)}function start(){if(ROUNDINFO.status!=1){alert("游戏状态不正确，请去后台先重置游戏哦！");return false}ajax_act_start().done(function(json){if(json.code<=0){alert(json.message)}}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})}function reset(){if(ROUNDINFO.status==1){return false}if(!confirm("确认要重玩本轮游戏吗？重置后本轮的中奖数据会被清除。")){return false}ajax_act_reset().done(function(json){if(json.code<=0){alert(json.message)}}).fail(function(){alert("请检查您的网络，有可能是断网了哦。")})}function init(data){window.sessionStorage[statesessionname]="idle";if(ROUNDINFO.status==1){StartPage.init();navbtns.showStartBtn()}if(ROUNDINFO.status==2){GamePage.init();navbtns.showResetBtn()}if(ROUNDINFO.status==3){EndPage.init(data);navbtns.showResetBtn()}}function processdata(data){if(ROUNDINFO.status==1){StartPage.update(data)}if(ROUNDINFO.status==2){GamePage.update(data);navbtns.showResetBtn()}if(ROUNDINFO.status==3){EndPage.update(data);navbtns.showResetBtn()}}function initRotateBg(){var main=$(".main");var w=main.width();var h=main.height();var size=w>h?w:h;size=size*1.5;$(".grab_redenvelop .bg_rotate").css({"width":size,"height":size,"left":-(size-w)/2,"top":-(size-w)/2})}return{"init":function(){checkingStatus()}}};var View_Result={"btn_close":$(".btn_close"),"html":function(){var html="";for(var i=0,l=WINNERS.length;i<l;i++){html+='<li class="b_money"><div class="b_contain">        <img src="'+WINNERS[i].avatar+'" class="user_photo">        <div class="user_name">恭喜'+WINNERS[i].nickname+"获得<br>"+WINNERS[i].prize.prizename+"X 1"+'</div>        <div class="prize_info" style="background: url('+WINNERS[i].prize.formatedtext.text+') no-repeat center;background-size: auto 100%;">        <p></p>        <span>'+""+"</span>        </div></div>        </li>"}html=html==""?"<li><p>很遗憾，本轮游戏没有人中奖哦</p></li>":html;return html},"show":function(){$(".pop_winninglist dl dd ul").html(this.html());$(".pop_winninglist").show().animateControl("bounceIn");$(".pop_mask").show();$(".pop_winninglist .list").niceScroll(".pop_winninglist .list ul",{cursorcolor:"#0c52d2",cursoropacitymin:"1",cursorborder:"0",cursorborderradius:"0"});this.btn_close.hide()},"update":function(){$(".pop_winninglist dl dd ul").html(this.html())},"hide":function(){$(".pop_winninglist").slideUp(500,function(){$(".pop_mask").hide()})},};var StartPage={"joinusers":[],"_renderjoinlist_timer":null,"joinnum_div":$(".players").find(".joinNum"),"init":function(){changeStatus();$(".begin").animateControl("zoomIn",function(){$(".begin").show()}).show();this.resetjoinlist();this.renderjoinlist()},"hide":function(){$(".begin").animateControl("flipOutX",function(){$(".begin").hide();clearTimeout(this._renderjoinlist_timer)})},"resetjoinlist":function(){$(".players .list").html('<img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">        <img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">        <img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">        <img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">        <img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">        <img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">        <img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">        <img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">        <img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">        <img class="avatar default" src="/Modules/Ydj/templates/assets/images/default.png">')},"update":function(data){var oldjoinnum=this.joinnum_div.text();var newjoinnum=data.sum+"人";if(oldjoinnum!=newjoinnum){this.joinnum_div.animateControl("fadeInDown").text(newjoinnum)}if(data.userlist==false){return false}if(data.userlist.length<=0){return false}this.joinusers=data.userlist},"renderjoinlist":function(){var self=this;if(this.joinusers.length>0){var user=this.joinusers.shift();var userhtml='<img class="avatar default" src="'+user.avatar+'" style="opacity:0;">';$(userhtml).prependTo(".players .list");$(".avatar.default").eq(10).remove();
$(".avatar.default").eq(0).animateControl("zoomIn").css({"opacity":1})}this._renderjoinlist_timer=setTimeout(function(){self.renderjoinlist()},500)}};function changeStatus(){if(lastgamestatus==ROUNDINFO.status){return}if(lastgamestatus==1){StartPage.hide()}if(lastgamestatus==2){GamePage.hide()}if(lastgamestatus==3){EndPage.hide()}lastgamestatus=ROUNDINFO.status}var GamePage={"right_winninglist_div":$(".right_winninglist"),"countnum_p":$(".countNum"),"redenvelop_box_div":$(".redenvelop_box"),"top_package_div":$(".top_package"),"_lefttime":0,"checkfrequency":3000,"times":1,"ctime":1,"leftprizenum":0,"winners":{},"newwinners_arr":[],"countdown_timer":null,"dropredpacket_timer":null,"init":function(){changeStatus();this.right_winninglist_div.show();this.right_winninglist_div.find(".pop_winninglist_a").removeClass("pop_winninglist_a");this.countnum_p.find("b.sec").text(ROUNDINFO.duration);this.countnum_p.show();this.redenvelop_box_div.show();this._lefttime=ROUNDINFO.duration;for(var i=1;i<=7;i++){if(i==1){for(var j=1;j<=1;j++){this.redenvelop_box_div.find(".redenvelop_list").append('<li class="redenvelop'+i+'" id="redenvelop'+i+"_"+j+'"></li>')}}if(i==2){for(var j=1;j<=1;j++){this.redenvelop_box_div.find(".redenvelop_list").append('<li class="redenvelop'+i+'" id="redenvelop'+i+"_"+j+'"></li>')}}if(i==3){for(var j=1;j<=2;j++){this.redenvelop_box_div.find(".redenvelop_list").append('<li class="redenvelop'+i+'" id="redenvelop'+i+"_"+j+'"></li>')}}if(i==4){for(var j=1;j<=2;j++){this.redenvelop_box_div.find(".redenvelop_list").append('<li class="redenvelop'+i+'" id="redenvelop'+i+"_"+j+'"></li>')}}if(i==5){for(var j=1;j<=3;j++){this.redenvelop_box_div.find(".redenvelop_list").append('<li class="redenvelop'+i+'" id="redenvelop'+i+"_"+j+'"></li>')}}if(i==6){for(var j=1;j<=3;j++){this.redenvelop_box_div.find(".redenvelop_list").append('<li class="redenvelop'+i+'" id="redenvelop'+i+"_"+j+'"></li>')}}if(i==7){for(var j=1;j<=4;j++){this.redenvelop_box_div.find(".redenvelop_list").append('<li class="redenvelop'+i+'" id="redenvelop'+i+"_"+j+'"></li>')}}}this.countDown();this.dropredpacket();this.shownewwinners()},"update":function(data){var self=this;if(data){self.newwinners_arr=self.newwinners_arr.concat(data)}},"hide":function(){$(".right_winninglist").hide();this.countnum_p.hide();this.redenvelop_box_div.find(".redenvelop_list").html("");this.redenvelop_box_div.hide();$(".right_winninglist dl dd.list ul").html("");clearTimeout(this._show_newwinners_timer);clearTimeout(this.countdown_timer);clearTimeout(this.dropredpacket_timer);this.countdown_timer=null;this._show_newwinners_timer=null;this.dropredpacket_timer=null;this.setCounter("倒计时",0,0)},"dropredpacket":function(){for(var i=1;i<=7;i++){if(i==1){for(var j=1;j<=1;j++){ani_redenvelop("#redenvelop"+i+"_"+j+"",1500)}}if(i==2){for(var j=1;j<=1;j++){ani_redenvelop("#redenvelop"+i+"_"+j+"",1200)}}if(i==3){for(var j=1;j<=2;j++){ani_redenvelop("#redenvelop"+i+"_"+j+"",900+(j-1)*400)}}if(i==4){for(var j=1;j<=2;j++){ani_redenvelop("#redenvelop"+i+"_"+j+"",1050+(j-1)*300)}}if(i==5){for(var j=1;j<=3;j++){ani_redenvelop("#redenvelop"+i+"_"+j+"",1000+(j-1)*200)}}if(i==6){for(var j=1;j<=3;j++){ani_redenvelop("#redenvelop"+i+"_"+j+"",800+(j-1)*200)}}if(i==7){for(var j=1;j<=4;j++){var ani_time=750+(j-1)*100;this.dropredpacket_timer=setTimeout("ani_redenvelop('#redenvelop"+i+"_"+j+"',"+ani_time+")",(j-1)*200)}}}},"_show_newwinners_timer":null,"shownewwinners":function(){var self=this;if(this.newwinners_arr.length>0){var item=this.newwinners_arr.shift();$(".pop_winning .user_photo").attr({src:item.userinfo.avatar});$(".pop_winning .prize_img").attr({src:PRIZES[item.prizeid].formatedtext.text});$(".pop_winning .user_info p").html(item.userinfo.nickname+"获得");$(".pop_winning .user_info span").text(PRIZES[item.prizeid].prizename+"X 1");$(".pop_winning").animateControl("bounceIn",function(){self._showwinners(item.userinfo,item.prizeid);self._show_newwinners_timer=setTimeout(function(){self.shownewwinners()},10)}).show()}else{self._show_newwinners_timer=setTimeout(function(){self.shownewwinners()},500)}},"_showwinners":function(userinfo,prizeid){prize_html='<li class="prize" data-id="'+userinfo.id+'">      <img src="'+userinfo.avatar+'" class="user_photo">      <div class="user_info">      <p>'+userinfo.nickname+"</p>      <span>恭喜获得"+PRIZES[prizeid].prizename+'！</span>      </div>      <img src="'+PRIZES[prizeid].formatedtext.text+'" class="prize_img">      </li>';$(".right_winninglist dl dd.list ul").css({marginTop:"-80px"});$(".right_winninglist dl dd.list ul").prepend(prize_html);$(".right_winninglist dl dd.list ul").animate({marginTop:"0px"},500);$(".right_winninglist dl dd.list ul li:gt(4)").remove()},"countDown":function(){var self=this;var duration=ROUNDINFO.lefttime*1000;var endTime=new Date().getTime()+duration;this.countdown_timer=setInterval(function(){var ssNum_n=(endTime-new Date().getTime())/1000;var ssNum_sec=parseInt(ssNum_n)>0?parseInt(ssNum_n):0;var ssNum_hm=ssNum_n.toFixed(2).substr(-2,2);
self._lefttime=ssNum_sec;self.setCounter("倒计时",ssNum_sec,ssNum_hm);if(ssNum_n<=0){clearInterval(self.countdown_timer);self.hide()}},10)},"setCounter":function(title,m,hm){this.countnum_p.find(".count-title").text(title);this.countnum_p.find("b.sec").text(m);this.countnum_p.find("b.hm").text(hm)}};var EndPage={"init":function(data){changeStatus();$(".countNum").html('游戏已结束<b class="sec" style="display:none">0</b>').show();$(".right_winninglist .list").addClass("pop_winninglist_a");$(".pop_winning").hide();this.update(data);View_Result.show()},"update":function(data){if(!data){return false}if(data.length>0){WINNERS=WINNERS.concat(data)}},"hide":function(){View_Result.hide();WINNERS=[];$(".countNum").html('<b class="count-title">倒计时</b><b class="sec">60</b><b>:</b><b class="hm">00</b>').hide()}};var ajax_act_reset=function(){return ajaxPostData("reset")};var ajax_act_start=function(){return ajaxPostData("start")};var ajaxGetData=function(){return $.ajax({"url":"/Modules/module.php?m=ydj&c=front&a=ajaxGetData","type":"get","dataType":"json"})};var ajaxPostData=function(action){return $.ajax({"url":"/Modules/module.php?m=ydj&c=front&a=ajaxPostData","type":"post","dataType":"json","data":{"action":action}})};function ani_redenvelop(elem,time){$(elem).css({"top":"-160px","-webkit-transition":"top 0ms linear"});var mywidth=parseInt($(elem).width());var myleft=Math.random()*(290-mywidth);var mytime=time*0.7+time*0.3*Math.random();$(elem).css({"left":myleft+"px","top":"100%","-webkit-transition":"top "+mytime+"ms linear"});redenvelop_timer=setTimeout("ani_redenvelop('"+elem+"','"+time+"')",mytime);if(parseInt($(".countNum b.sec").text())<=0){clearInterval(redenvelop_timer)}}var navbtns=function(){var configid=ROUNDINFO.id;function setRoundbar(){if(configs.length>1){var btns=[];for(var i=0,l=configs.length;i<l;i++){var iscurrent=configid==configs[i]["id"]?1:2;btns[i]={"name":"摇大奖","action":"/Modules/module.php?m=ydj&c=front&a=index&id="+configs[i]["id"],"icon":"iconydj","current":iscurrent}}window.top.roundbar().init(btns)}}function showStartBtn(){var opts={};opts.btn_start=function(){window.sessionStorage[statesessionname]="start"};var commonbtns=[];var btns=$.extend(opts,commonbtns);window.top.minibar.init(btns)}function showResetBtn(){var opts={};opts.btn_reset=function(){window.sessionStorage[statesessionname]="reset"};var commonbtns=[];var btns=$.extend(opts,commonbtns);window.top.minibar.init(btns)}return{"init":function(){setRoundbar()},"showStartBtn":function(){showStartBtn()},"showResetBtn":function(){showResetBtn()}}}();
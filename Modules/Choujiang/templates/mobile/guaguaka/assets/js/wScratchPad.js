!function(a){function n(t,e){return this.sp=null,this.settings=t,this.$elem=e,this.enabled=!0,this.scratch=!1,this.canvas=null,this.ctx=null,this}a.fn.wScratchPad=function(e,i){if("object"==typeof e)i=e;else if("string"==typeof e){var s=[],t=this.each(function(){var t=a(this).data("_wScratchPad");t&&("reset"===e?t.reset():"clear"===e?t.clear():"enabled"===e?t.enabled=!0===i:void 0!==a.fn.wScratchPad.defaultSettings[e]&&(void 0!==i?t.settings[e]=i:s.push(t.settings[e])))});return 1===s.length?s[0]:0<s.length?s:t}return i=a.extend({},a.fn.wScratchPad.defaultSettings,i||{}),this.each(function(){var t=a(this),e=jQuery.extend(!0,{},i);if(!document.createElement("canvas").getContext)return t.html("Browser does not support HTML5 canvas, please upgrade to a more modern browser."),!1;var s=new n(e,t);t.append(s.generate()),s.pixels=s.canvas.width*s.canvas.height,t.data("_wScratchPad",s),s.init()})},a.fn.wScratchPad.defaultSettings={width:210,height:100,image:null,image2:null,color:"#336699",overlay:"none",size:10,scratchDown:null,scratchUp:null,scratchMove:null,cursor:null},n.prototype={generate:function(){var e=this;return this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.sp=a("<div></div>").css({position:"relative"}).append(a(this.canvas).attr("width",this.settings.width+"px").attr("height",this.settings.height+"px")),a(this.canvas).mousedown(function(t){if(!e.enabled)return!0;t.preventDefault(),t.stopPropagation(),e.canvas_offset=a(e.canvas).offset(),e.scratch=!0,e.scratchFunc(t,e,"Down")}).mousemove(function(t){t.preventDefault(),t.stopPropagation(),e.scratch&&e.scratchFunc(t,e,"Move")}).mouseup(function(t){t.preventDefault(),t.stopPropagation(),e.scratch&&(e.scratch=!1,e.scratchFunc(t,e,"Up"))}),this.bindMobile(this.sp),this.sp},bindMobile:function(t){t.bind("touchstart touchmove touchend touchcancel",function(){var t=event.changedTouches[0],e="";switch(event.type){case"touchstart":e="mousedown";break;case"touchmove":e="mousemove";break;case"touchend":e="mouseup";break;default:return}var s=document.createEvent("MouseEvent");s.initMouseEvent(e,!0,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(s),event.preventDefault()})},init:function(){this.sp.css("width",this.settings.width),this.sp.css("height",this.settings.height),this.sp.css("cursor",this.settings.cursor?'url("'+this.settings.cursor+'"), default':"default"),a(this.canvas).css({cursor:this.settings.cursor?'url("'+this.settings.cursor+'"), default':"default"}),this.canvas.width=this.settings.width,this.canvas.height=this.settings.height,this.pixels=this.canvas.width*this.canvas.height,this.settings.image2?this.drawImage(this.settings.image2):("none"!=this.settings.overlay?(this.settings.image&&this.drawImage(this.settings.image),this.ctx.globalCompositeOperation=this.settings.overlay):this.setBgImage(),this.ctx.fillStyle=this.settings.color,this.ctx.beginPath(),this.ctx.rect(0,0,this.settings.width,this.settings.height),this.ctx.fill())},reset:function(){this.ctx.globalCompositeOperation="source-over",this.init()},clear:function(){this.ctx.clearRect(0,0,this.settings.width,this.settings.height)},setBgImage:function(){this.settings.image&&this.sp.css({backgroundImage:"url("+this.settings.image+")"})},drawImage:function(t){var e=this,s=new Image;s.src=t,a(s).load(function(){e.ctx.drawImage(s,0,0),e.setBgImage()})},scratchFunc:function(t,e,s){t.pageX=Math.floor(t.pageX-e.canvas_offset.left),t.pageY=Math.floor(t.pageY-e.canvas_offset.top),e["scratch"+s](t,e),e.settings["scratch"+s]&&e.settings["scratch"+s].apply(e,[t,e.scratchPercentage(e)])},scratchPercentage:function(t){for(var e=0,s=t.ctx.getImageData(0,0,t.canvas.width,t.canvas.height),i=0,a=s.data.length;i<a;i+=4)0==s.data[i]&&0==s.data[i+1]&&0==s.data[i+2]&&0==s.data[i+3]&&e++;return e/t.pixels*100},scratchDown:function(t,e){e.ctx.globalCompositeOperation="destination-out",e.ctx.lineJoin="round",e.ctx.lineCap="round",e.ctx.strokeStyle=e.settings.color,e.ctx.lineWidth=e.settings.size,e.ctx.beginPath(),e.ctx.arc(t.pageX,t.pageY,e.settings.size/2,0,2*Math.PI,!0),e.ctx.closePath(),e.ctx.fill(),e.ctx.beginPath(),e.ctx.moveTo(t.pageX,t.pageY)},scratchMove:function(t,e){e.ctx.lineTo(t.pageX,t.pageY),e.ctx.stroke()},scratchUp:function(t,e){e.ctx.closePath()}}}(jQuery);
var IS_SAFARI_OR_UIWEBVIEW=/(iPhone|iPod|iPad).*AppleWebKit/i.test(navigator.userAgent),ImageResizer=function(t){var o={resizeMode:"auto",dataSource:"",dataSourceType:"image",maxWidth:500,maxHeight:500,onTmpImgGenerate:function(t){},success:function(t,e){}};$.extend(o,t);var n={getBase4FromImgFile:function(t,a){var e=new FileReader;e.onload=function(t){var e=t.target.result;a&&a(e)},e.readAsDataURL(t)},getImgFromDataSource:function(t,e,a){var r=new Image;"img"==e||"image"==e?(r.src=$(t).attr("src"),a&&a(r)):"base64"==e?(r.src=t,a&&(r.onload=function(){a(r)})):"canvas"==e?(r.src=t.toDataURL("image/jpeg"),a&&a(r)):"file"==e&&this.getBase4FromImgFile(function(t){r.src=t,a&&a(r)})},getResizeSizeFromImg:function(t,e){var a={w:$(t)[0].naturalWidth,h:$(t)[0].naturalHeight};if(a.w<=o.maxWidth&&a.h<=o.maxHeight)return a;if("auto"!=o.resizeMode)return"width"==o.resizeMode?a.w<=o.maxWidth?a:i={w:o.maxWidth,h:parseInt(o.maxWidth/r)}:"height"==o.resizeMode?a.h<=o.maxHeight?a:n={w:parseInt(o.maxHeight*r),h:o.maxHeight}:void 0;var r=parseFloat(a.w/a.h),i={w:o.maxWidth,h:parseInt(o.maxWidth/r)},n={w:parseInt(o.maxHeight*r),h:o.maxHeight};return i.h<=o.maxHeight?i:n.w<=o.maxWidth?n:{w:o.maxWidth,h:o.maxHeight}},drawToCanvas:function(t,e,a,r,i,n,o){var g=document.createElement("canvas"),h=g.getContext("2d"),m={x:0,y:0,w:g.width=e,h:g.height=a};3==n&&(h.rotate(180*Math.PI/180),m.x=-e,m.y=-a),6==n&&(g.width=a,g.height=e,h.rotate(90*Math.PI/180),m.x=0,m.y=-a,m.w=e,m.h=a),8==n&&(g.width=a,g.height=e,h.rotate(270*Math.PI/180),m.x=-e,m.y=0,m.w=e,m.h=a),h.drawImage(t,m.x,m.y,m.w,m.h);var u=g.toDataURL("image/png");o&&o(u,g)}};n.getImgFromDataSource(o.dataSource,o.dataSourceType,function(t){var e=getOrientation(base64ToArrayBuffer(o.dataSource));console.log(e);var a=t;o.onTmpImgGenerate(t);var r=n.getResizeSizeFromImg(a,e),i={w:$(a)[0].naturalWidth,h:$(a)[0].naturalHeight};n.drawToCanvas(a,r.w,r.h,i.w,i.h,e,function(t,e){o.success(t,e)})});return{}};function base64ToArrayBuffer(t){t=t.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var e=atob(t),a=e.length,r=new ArrayBuffer(a),i=new Uint8Array(r),n=0;n<a;n++)i[n]=e.charCodeAt(n);return r}function getStringFromCharCode(t,e,a){var r,i="";for(a+=r=e;r<a;r++)i+=String.fromCharCode(t.getUint8(r));return i}function getOrientation(t){var e,a,r,i,n,o,g,h,m,u=new DataView(t),d=u.byteLength;if(255===u.getUint8(0)&&216===u.getUint8(1))for(h=2;h<d;){if(255===u.getUint8(h)&&225===u.getUint8(h+1)){o=h;break}h++}if(o&&(a=o+10,"Exif"===getStringFromCharCode(u,o+4,4)&&((i=18761===(n=u.getUint16(a)))||19789===n)&&42===u.getUint16(a+2,i)&&8<=(r=u.getUint32(a+4,i))&&(g=a+r)),g)for(d=u.getUint16(g,i),m=0;m<d;m++)if(h=g+12*m+2,274===u.getUint16(h,i)){h+=8,e=u.getUint16(h,i),IS_SAFARI_OR_UIWEBVIEW&&u.setUint16(h,1,i);break}return e}
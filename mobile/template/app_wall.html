<style> 
{literal}
html { font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100% }
body { margin: 0 }
h1 { margin: 0; padding: 0 }
body, html { width: 100%; height: 100%; font-family: Helvetica Neue, Helvetica, Arial, Microsoft YaHei, \\5FAE\8F6F\96C5\9ED1, STXihei, \\534E\6587\7EC6\9ED1, serif }
article, aside, details, figcaption, figure, footer, header, hgroup, main, menu, nav, section, summary { display: block }
audio, canvas, progress, video { display: inline-block; vertical-align: baseline }
audio:not ([controls]) { display: none; height: 0 }
[hidden], template { display: none }
a { background-color: transparent; text-decoration: none; -webkit-tap-highlight-color: transparent }
a:active, a:hover, a:visited { text-decoration: none; outline: 0 }
abbr[title] { border-bottom: 1px dotted }
b, strong { font-weight: 700 }
dfn { font-style: italic }
h1 { font-size: 2em; margin: .67em 0 }
mark { background: #ff0; color: #000 }
small { font-size: 80% }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline }
sup { top: -.5em }
sub { bottom: -.25em }
img { border: 0 }
svg:not (:root) { overflow: hidden }
figure { margin: 1em 40px }
hr { box-sizing: content-box; height: 0 }
pre { overflow: auto }
code, kbd, pre, samp { font-family: monospace; font-size: 1em }
button, input, optgroup, select, textarea { color: inherit; font: inherit; margin: 0 }
button { overflow: visible }
button, select { text-transform: none }
button, html input[type=button], input[type=reset], input[type=submit] { -webkit-appearance: button; cursor: pointer }
button[disabled], html input[disabled] { cursor: default }
button::-moz-focus-inner { border: 0; padding: 0 }
textarea { line-height: normal }
textarea::-moz-focus-inner { border: 0; padding: 0 }
input[type=checkbox], input[type=radio] { box-sizing: border-box; padding: 0 }
input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { height: auto }
input[type=search] { -webkit-appearance: textfield; box-sizing: content-box }
input[type=search]::-webkit-search-cancel-button, input[type=search]::-webkit-search-decoration { -webkit-appearance: none }
fieldset { border: 1px solid silver; margin: 0 2px; padding: .35em .625em .75em }
legend { border: 0; padding: 0 }
textarea { overflow: auto }
optgroup { font-weight: 700 }
td, th { padding: 0 }
.native-scroll { overflow: auto; -webkit-overflow-scrolling: touch }
[hidefocus], body, button, input, keygen, legend, select, summary, textarea { outline: 0 }
* { border: 0; margin: 0; padding: 0 }
*, :after, :before { box-sizing: border-box }
body, html { width: 100%; height: 100% }
img { max-width: 100%; width: auto\9; height: auto; -ms-interpolation-mode: bicubic }
@media (max-width:640px) {
	.goods-show { width: 100%; margin: 10px 0 }
}
@media (min-width:641px) {
	.goods-show { width: 45%; margin: 2.5% }
}
dd, div, dl, dt, form, h1, h2, h3, h4, h5, img, li, p, ul { border: 0 none; list-style: outside none none; margin: 0; padding: 0 }
body { background: #f4f4f4; color: #555; font-size: 18px; margin: 0 auto; max-width: 640px }
body, dd, div, dl, dt, fieldset, form, h1, h2, h3, h4, h5, h6, img, li, ol, p, table, td, ul { margin: 0; padding: 0; border: 0 }
* { margin: 0; outline: 0 none; padding: 0; vertical-align: baseline }
body, div.navbar, header { margin: auto; max-width: 640px }
body { color: #666; font-family: Helvetica, STHeiti STXihei, Microsoft JhengHei, Microsoft YaHei, Arial; font-size: 14px; line-height: 1.5 }
#loading { width: 100%; height: 36px; border-radius: 2px; padding-top: 10px; margin-top: 10px; text-align: center }
#loading .blank { height: 12px; width: 12px; border-radius: 50%; border-top: 1px solid rgba(0, 0, 0, .5); border-left: 1px solid rgba(0, 0, 0, .3) }
#loading #load_text, #loading .blank { display: inline-block }
#loading #bounce { animation: beChange 1s infinite ease-in-out; -moz-animation: beChange 1s infinite ease-in-out; -webkit-animation: beChange 1s infinite ease-in-out; -o-animation: beChange 1s infinite ease-in-out }
.chatContainer { position: relative; height: 100% }
.imageMask { border-radius: 10px; width: 95% }
.imageMask, .imageMask2 { position: absolute; height: 100%; background-color: #000; opacity: .4; z-index: 1000000000000000000 }
.imageMask2 { width: 100% }
.messageLoadingBox { position: absolute; height: 50px; width: 50%; top: 50% }
.messageLoading { z-index: 100000000000000000000; right: -10px !important; top: -10px !important; height: 25px; width: 25px }
.messageFailedBox { position: absolute; height: 50px; width: 50%; top: 50%; right: 100% }
.messageFailed { z-index: 100000000000000000000; right: 5px !important; top: -10px !important; height: auto; width: 25px }
.checkMoreMessage { margin-top: 20px; width: 100%; height: 20px; font-size: 15px; text-align: center; position: relative }
.chatBanner { background-color: #EEE; position: fixed; top: 0; z-index: 100; width: 100%; max-width: 640px; height: 52px; font-size: 15px }
.chatBackIcon { width: 8%; height: 20px; margin-left: 2%; margin-top: 9px }
.chatPinduoduoLogo { display: inline-block; width: 15%; height: auto; margin-left: 0 }
.chatMallName { display: inline-block; width: 100%; text-align: center; line-height: 52px; font-size: 15px; color: gray }
.chatToMall { position: absolute; top: 8px; right: 10px; height: 18px; width: auto }
.chatRedDot { width: 12px; height: 12px; border-radius: 12px; -webkit-border-radius: 12px; background-color: #c00; position: absolute; right: -5px }
.chatTimeShow { display: table; margin-left: auto; margin-right: auto; position: relative; width: auto; padding: 2px 4px; height: 20px; line-height: 20px; font-size: 12px; color: #fff; text-align: center; background-color: #d3d3d3; margin-bottom: 15px; border-radius: 5px }
.messageToSend { position: fixed; width: 100%; max-width: 640px; background-color: #f4f4f6; bottom: 0; border-top: 1px solid #d7d8d8 }
.messageContent { width: 70%; height: 34px; margin-top: 6px; margin-left: 10px; border: 1px solid #e6e6e6; font-size: 15px !important; background-color: #fff }
.chatMessageSend { display: inline-block; float: right; margin-right: 5px; width: 68px; height: 30px; margin-top: 8px; border: 1px solid #999; border-radius: 5px; background-color: #fff; font-size: 13px; line-height: 30px; color: #999; font-family: Arial, Microsoft YaHei, \\9ED1\4F53, \\5B8B\4F53, sans-serif }
.sendExpression { width: 30px; height: 30px; margin-top: 5px; border-radius: 30px; -webkit-border-radius: 30px; margin-left: 5px }
.messageContainer { padding-top: 40px; padding-bottom: 60px; position: relative; width: 100%; max-width: 640px; height: 100%; overflow-y: scroll }
.messageShow { display: block; margin-top: 10px; overflow: auto }
.chatMallMessage, .messageShow { width: 100%; height: auto; position: relative }
.chatMallAvatar { display: inline-block; height: 40px; width: 40px; margin-left: 15px; border: 1px solid #e6e6e6 }
.chatLeftContent { display: inline-block; position: relative }
.chatLeftContent img { position: absolute; left: -2px; top: 10px }
.chatLeftContent p { float: left; border-radius: 5px; padding: 10px 15px; margin-left: 10px; white-space: normal; background-color: #fff; word-break: break-all; max-width: 200px; font-size: 14px }
.messagePic { margin-right: 10px; background-color: #a0e75a }
.messagePic, .messagePicLeft { border-radius: 10px; padding: 0 5px; width: auto; height: auto }
.messagePicLeft { margin-left: 10px; background-color: #fff }
.chatPic { right: 0 !important }
.chatPic, .chatPicLeft { position: relative !important; top: 5px !important; margin-bottom: 10px; width: 150px; height: auto }
.chatPicLeft { left: 0 !important }
.customerMessage { width: 100%; position: relative; overflow: auto; padding: 5px 0 }
.chatUserAvatar { position: absolute; right: 15px; height: 40px; width: 40px; border: 1px solid #e6e6e6 }
.chatRightContent { display: inline-block; position: relative; float: right; margin-right: 60px }
.chatRightContent .arrow { position: absolute; right: 0px; top: 8px }
.chatRightContent p { float: right; border-radius: 5px; padding: 9px 15px; margin-right: 10px; white-space: normal; background-color: #9eea6a; word-break: break-all; max-width: 200px; font-size: 14px;color: #444;}
.chatRightContent p img{width: 36px;height: 36px;}
.sendPicOrVideo { width: 100%; height: 100%; opacity: 0 }
img { border: 0 none; vertical-align: top }
.img-btn { right: 13px; background-image: url(template/app/images/w-icon-img.png); position: absolute; display: block; top: 50%; border: none; width: 30px; height: 30px; background-color: transparent; background-repeat: no-repeat; background-position: center center; background-size: 30px;transform:translateY(-50%); -webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-tap-highlight-color: transparent;}
.button_1 { font-size: 18px; color: #ffffff; line-height: 20px; text-align: center; border: 1px solid #666666; background-color: #ff6600; padding: 10px 0; }
.button_1:active { background-color: #d55500; }
.button_1_disabled { font-size: 18px; color: #eeeeee; line-height: 20px; text-align: center; border: 1px solid #666666; background-color: #ff6600; padding: 10px 0; }
#dt_review_box { display: none; position: fixed; left: 0; bottom: -500px; z-index: 2000; width: 100%; background-color: #dddddd; padding-bottom: 500px; }
#dt_review_box_main { position: relative; margin: 3px 8px;height: 47px; }
#dt_review_box_emo_button, #dt_review_box_emo_button_active { position: absolute; left: 0; top: 50%; width: 30px; overflow: hidden;transform:translateY(-50%); -webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-tap-highlight-color: transparent;}
#dt_review_box_emo_button img, #dt_review_box_emo_button_active img { width: 30px; height: 30px;}
#dt_review_box_emo_button:active { filter: alpha(opacity = 0); -moz-opacity: 0; opacity: 0; }
#dt_review_box_input { margin: 0 66px 0 38px; border: 1px solid #ccc; background-color: #FFF; padding: 8px 3px;height:47px; border-radius: 5px; }
#dt_review_box_input textarea { width: 100%; overflow: hidden; border: 1px solid #FFF; height: 31px; resize: none;line-height: 31px;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-tap-highlight-color: transparent; }
#dt_review_box_button { position: absolute; right: 0; top: 50%; width: 68px; text-align: center;transform:translateY(-50%); }
#dt_review_box_button button { width: 60px; height: 45px; overflow: hidden; font-size: 14px; background-color: #1AAD19; border-radius: 5px; color: #FFF; cursor: pointer; border: none;position: relative;margin-left: 5px;}
#dt_review_box_button button:after{
	content: " ";
    width: 200%;
    height: 200%;
    position: absolute;
    top: 0;
    left: 0;
    border: 1px solid rgba(0, 0, 0, 0.2);
    -webkit-transform: scale(0.5);
    transform: scale(0.5);
    -webkit-transform-origin: 0 0;
    transform-origin: 0 0;
    box-sizing: border-box;
    border-radius: 10px;
}
#dt_review_box_button button:active { background-color: #0082c6; }
#dt_review_box_emo { display: none; padding-top: 8px; }
ul { list-style: none outside none; }
li { display: list-item; text-align: -webkit-match-parent; }
ul, li { margin: 0; padding: 0 }
.emo { float: left; padding: 6px; }
.emo img { width: 36px; height: 36px; }
.dt_emo { width: 36px; height: 36px; }
textarea { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
{/literal}
</style>
<script src="template/app/js/jquery-2.1.4.js"></script>
<script>
var user_avatar = "{$user['avatar']}";
var openid="{$user['openid']}";
</script>
</head>
<link rel="stylesheet" href="template/app/css/weui.min.css">
<link rel="stylesheet" href="template/app/css/jquery-weui.min.css">
<link rel="stylesheet" href="/assets/plugs/emoji/emoji.css" />
<body>

	<div class="chatContainer">
		<div class="messageContainer">
			<div class="messageInnerContainer">
				<div class="checkMoreMessage">...点击查看历史消息...</div>
			</div>
		</div>
		<div class="messageToSend">
			<div id="dt_review_box_main">
				<div id="dt_review_box_input">
					<textarea type="text" placeholder="请输入您想说的话"
						id="dt_review_form_content" class="input" onpaste="return false"
						oncontextmenu="return false" oncopy="return false"
						oncut="return false" maxlength="200"></textarea>
				</div>
				<div id="dt_review_box_emo_button" ontouchstart="">
					<img src="template/app/images/express.png">
				</div>
				<div id="dt_review_box_button" style="display: none">
					<button id="dt_review_form_post" class="button_1_disabled"
						ontouchstart="">发送</button>
				</div>
				<button type="button" id="imgBtn" class="send-btn img-btn sendPicBg"></button>

				<input type="file"  id="picFile" style="display:none;" onchange="readFile(this)" />
				<div style="display: none;" id="dt_review_box_emo"></div>
				<div class="clear"></div>
			</div>
		</div>
	</div>
<script type="text/javascript" src="template/app/js/image.js"></script>
<script>
{literal}
;(function($) {
    if (typeof $ === 'undefined') {
        return;
    }

    var Chat = function(selector, opts){
        this.$el = $(selector);
        this.uniqueId = 0;
        this._extend(opts);
        this._initialize();
    };
    Chat.prototype = {
        $: function(selector){
            return this.$el.find(selector);
        },
        _extend: function(opts){
            for(var p in opts){
                this[p] = opts[p];
            }
        },
        _initialize: function() {
            if(this.initialize){
                this.initialize.call(this);
            }
        },
        bindEvent: function() {
            var that = this;
            var $el = that.$el;

            $el.off();
            $el.on('focus blur keyup keydown', '#dt_review_form_content', function(e){
                if ($(this).val() !== '') {
                    that.showSendBtn();
                } else {
                    that.hideSendBtn();
                }
            });
            
        },
        showSendBtn: function(){
            this.$('#imgBtn').hide();
            //this.$('.moxie-shim').hide();
            this.$('#dt_review_box_button').show();
        },
        hideSendBtn: function () {
            //if (!Global.ContentType || (Global.ContentType && Global.ContentType==10)) {
                this.$('#dt_review_box_button').hide();
            //}
            this.$('#imgBtn').show();
            //this.$('.moxie-shim').show();
        },
    };
    window.Chat = Chat;
})(window.jQuery);
$(function() {
    new Chat('#dt_review_box_main', {
        message: null,
        prichat: null,
        initialize: function(){
            var that = this;
            that.bindEvent();
           
        }
    });
});

$(window).resize(function(){
	var active=$(document.activeElement);
	if(active.is('input') || active.is('textarea')) {
		window.setTimeout(function() {
			active.scrollIntoViewIfNeeded();
		},0);
	}
});

function scrollToEnd(){//滚动到底部
	var h = $(document).height()-$(window).height();
	$(document).scrollTop(h); 
}
$('#dt_review_form_content').on('blur',scrollToEnd);

$(document).ready(function(){
$('#dt_review_form_post').on('click',function(){
   var content =_common._trim($("#dt_review_form_content").val());
   if (content == "") {
	  _loading_toast._show('请先输入内容！');
	  $("#dt_review_form_content").focus()
      return;
   }
   _meepoajax._ajax({
				do_it:'msg_send',
				type: "POST",                        
				dataType: 'JSON',      
				cache: false,                 
				formPata:{'openid':openid,'content':content},
				success:function(data) {
						if(data.errno==0){
						  _loading_toast._show(data.message.tip);
						  $('#imgBtn').show();
						  $('#dt_review_box_button').hide();
							var html = '<div class="messageShow">'+
							'<div class="customerMessage">'+
								'<div class="chatTimeShow">'+n()+
									
								'</div>'+
								'<img class="chatUserAvatar" src="'+user_avatar+'">'+
								'<div class="chatRightContent">'+
									'<img class="arrow" src="template/app/images/chat_right.png">'+
									
									'<p >'+data.message.content+'</p>'+
									
								'</div>'+
							'</div>'+
						'</div>';
							if($('.messageShow').length>0){
								$(".messageInnerContainer").append(html);
							}else{
								 $(".checkMoreMessage").after(html);
							}
						}else{
							_loading_toast._show(data.message);
						}
						setTimeout("scrollTop()",100);
						_emo._hide("dt_review_box_emo");
						$('#dt_review_form_content').val('');
				}

		});
		
})

$('#dt_review_box_emo_button').click(function() {
	_emo._show("dt_review_box_emo", function(index) {
      $("#dt_review_form_content").val($("#dt_review_form_content").val() + _emo._text[index]);
    });
})
$('.checkMoreMessage').click(function() {
		//_loading_toast._show('loading....');
		var page = $('.messageShow').length;
		_meepoajax._ajax({
				do_it:'msg_getmore',
				type: "POST",                        
				dataType: 'json',      
				cache: false,                 
				formPata:{'openid':openid,'page':page},
				success:function(data) {
						if(data.errno==0){
							if(data.message.length>0){
								 var html = '';
								 data.message = data.message.reverse();
								 for (var i = 0; i < data.message.length; i++) {
									 var obj = data.message[i];
									 if(obj.type==2){
										var news = '<div class="messagePic" onclick="preview(this)" data-num="'+obj.image+'">'+
											'<img src="'+obj.content+'" class="chatPic" >'+
										'</div>';
									 }else{
										var news = '<p >'+obj.content+'</p>';
									 }
									 html += '<div class="messageShow">'+
										'<div class="customerMessage">'+
											'<div class="chatTimeShow">'+n(obj.createtime)+
												
											'</div>'+
											'<img class="chatUserAvatar" src="'+user_avatar+'">'+
											'<div class="chatRightContent">'+
												'<img class="arrow" src="template/app/images/chat_right.png">'+ news +
											'</div>'+
										'</div>'+
									'</div>';
									
								 }
								 $(".checkMoreMessage").after(html);
								 setTimeout("scrollTop()",100);
							}else{
								_loading_toast._show('加载完了!');
								$('.checkMoreMessage').remove();
							}
						}else{
							_loading_toast._show(data.message);
							
						}
				}
		});
});

})
function preview(b){
	 var img = b.getAttribute('data-num');
	if("undefined" != typeof img && ''!=img){
		wx.previewImage({
		  current:img,
		  urls: [img]
		
		});
	}

}
function scrollTop(){
$(".messageContainer").scrollTop($(".messageContainer")[0].scrollHeight - $(".messageContainer")[0].clientHeight)
}
var _emo= {
    _text: ["[笑脸]", "[感冒]", "[流泪]", "[发怒]", "[爱慕]", "[吐舌]", "[发呆]", "[可爱]", "[调皮]", "[寒冷]", "[呲牙]", "[闭嘴]", "[害羞]", "[苦闷]", "[难过]", "[流汗]", "[犯困]", "[惊恐]", "[咖啡]", "[炸弹]", "[西瓜]", "[爱心]", "[心碎]"],
    _indexOf: function(text) {
        if (_emo._text.indexOf) {
			
            return _emo._text.indexOf(text);
        }
        for (var i = 0, _len = _emo._text.length; i < _len; i++) {
            if (_emo._text[i] == text) {
                return i;
            }
        }
        return -1;
    },
    _insertFun: null,
    _show: function(id, fun) {
        _emo._insertFun = fun;
        if ($("#" + id).children().length == 0) {
            var _html = "<ul>";
            for (var i = 0; i < 23; i++) {
                 _html += "<li class='emo' ontouchstart='' onclick='_emo._insert(" + i + ")'><img src='" + 'template/app/' + "/emo/" + (i + 1) + ".png'></li>";
            }
            _html += "</ul>";
            $("#" + id).html(_html);
        }
		
			$("#" + id).slideToggle();
		
    },
    _hide: function(id) {
        $("#" + id).hide();
    },
    _insert: function(index) {
		if($('#imgBtn').css('display')=='block'){
			$('#imgBtn').hide();
			$('#dt_review_box_button').show();
		}
        (_emo._insertFun)(index);
    },
    _toCode: function(content) {
        return content.replace(/\[[\u4e00-\u9fa5]{1,2}\]/g, function(a) {
            var _code = _emo._indexOf(a) + 1;
            return _code == 0 ? a : "[/" + _code + "]";
        });
    }
};
 var images = {
    localId: [],
    serverId: []
  };
 function getfileextension(filename){
	filename=filename.toLowerCase();
	var filetypes=['jpg','jpeg','png'];
	var extension=filename.split('.');
	extension=extension[extension.length-1];
	for(var i=0,l=filetypes.length;i<l;i++){
		if(extension==filetypes[i]){
			return filetypes[i];
		}
	}
	return false;
 }
 function readFile(obj){ 
	var file = obj.files[0];
	//判断类型是不是图片
	if(!/image\/\w+/.test(file.type)){   
        alert("请确保文件为图像类型"); 
        return false; 
	} 
	var extension=getfileextension(file['name']);
	var reader = new FileReader(); 
	reader.readAsDataURL(file);
	reader.onload = function(e){
		var self=this;
		var maxfilesize=256*1024;
		var maxWidth=800;
		var maxheight=600;
		if(file.size>maxfilesize){//文件大于256k
			var _ir=ImageResizer({
                resizeMode:"auto",
                dataSource:self.result,
                dataSourceType:"base64",
                maxWidth:800, //允许的最大宽度
                maxHeight:600, //允许的最大高度。
                onTmpImgGenerate:function(img){
                },
                success:function(resizeImgBase64,canvas){
                	uploadimg(resizeImgBase64,extension);
                }
            });
		}else{
			uploadimg(this.result,extension);
		} 
	} 
} 
 $('.sendPicBg').click(function(){
	 $('#picFile').click();
	 
 });
 
 function uploadimg(imgbase64,extension){
	 var html = '<div class="messageShow">'+
		'<div class="customerMessage">'+
			'<div class="chatTimeShow">'+n()+
			'</div>'+
			'<img class="chatUserAvatar" src="'+user_avatar+'">'+
			'<div class="chatRightContent">'+
				'<img class="arrow" src="template/app/images/chat_right.png">'+
				'<div class="messagePic">'+
            '<img src="template/app/images/loading.gif" class="chatPic">'+
        '</div>'+
			'</div>'+
		'</div>'+
	'</div>';
	$(".messageInnerContainer").append(html);
	_meepoajax._ajax({
	do_it:'msg_uploadimg',
	type: "POST",                        
	dataType: 'json',      
	cache: false,                 
	formPata:{'msg_send':openid,'imgbase64':imgbase64,'filetype':extension},
	success:function(data) {
			if(data.errno==0){
				_loading_toast._show(data.message.tip);
				if($('.messageShow').length>0){
					var messages=$('.messageShow');
					$(messages[messages.length-1]).find('.chatPic').attr('src',data.message.picurl);
				}else{
					 $(".checkMoreMessage").after(html);
				}
				setTimeout("scrollTop()",100);
				_emo._hide("dt_review_box_emo");
			}else{
				_loading_toast._show(data.message);
				$messages=$(".messageInnerContainer").find('.messageShow');
				$messages.eq($messages.length-1).remove();
			}
	}
	});
 }
 

function dataURLtoBlob(dataurl) {
	var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
		bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
	while(n--){
		u8arr[n] = bstr.charCodeAt(n);
	}
	return new Blob([u8arr], {type:mime});
}
{/literal}
</script>